<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; font-src https://cdnjs.cloudflare.com; img-src 'self' data: blob:; connect-src 'self'">
  
  <title>GospelSwipe Pro - Digital Evangelism Platform</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#2c3e50">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="description" content="AI-powered gospel presentation with prayer journal, multi-language support, and 100% offline evangelism tools. Made in Nigeria üá≥üá¨">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkdvc3BlbFN3aXBlIFBybyIsCiAgInNob3J0X25hbWUiOiAiR29zcGVsU3dpcGUiLAogICJzdGFydF91cmwiOiAiL2luZGV4Lmh0bWwiLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMyYzNlNTAiLAogICJ0aGVtZV9jb2xvciI6ICIyYzNlNTAiLAogICJpY29ucyI6IFtdLAogICJjYXRlZ29yaWVzIjogWyJyZWxpZ2lvbiIsICJ1dGlsaXR5Il0KfQ==">
  <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48dGV4dCB5PSIuOWVtIiBmb250LXNpemU9IjkwIj7wn5udeTwvdGV4dD48L3N2Zz4=">
  
  <!-- Fonts & Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    :root {
      --primary: #2c3e50; --secondary: #3498db; --accent: #e74c3c; --success: #27ae60;
      --warning: #f39c12; --premium: #9b59b6; --light: #ecf0f1; --dark: #1a1a1a;
      --radius: 12px; --shadow: 0 8px 30px rgba(0,0,0,0.12); --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --glass: rgba(255,255,255,0.08); --glass-border: rgba(255,255,255,0.12);
      --slide-bg-start: #2c3e50; --slide-bg-end: #34495e;
    }

    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html { height: 100%; overflow: hidden; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.6; color: var(--light);
      background: linear-gradient(135deg, var(--primary) 0%, #34495e 100%);
      min-height: 100vh; position: relative; transition: var(--transition);
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      user-select: none; -webkit-user-select: none; overflow: hidden;
    }
    body.dark-mode { background: linear-gradient(135deg, #0f1419 0%, #1a252f 100%); }

    #loading {
      position: fixed; inset: 0; background: var(--primary);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      z-index: 999999; transition: opacity 0.5s;
    }
    .loader {
      width: 48px; height: 48px; border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%; border-top-color: #fff;
      animation: spin 1s ease-in-out infinite; margin-bottom: 20px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .app-container { display: none; position: relative; width: 100%; height: 100vh; overflow: hidden; z-index: 1; }
    .app-container.active { display: block; }

    #home-screen {
      position: fixed; inset: 0; padding: 20px 20px calc(70px + env(safe-area-inset-bottom));
      display: flex; flex-direction: column; overflow-y: auto;
      -webkit-overflow-scrolling: touch; z-index: 100;
      background: linear-gradient(135deg, var(--primary) 0%, #34495e 100%);
    }
    body.dark-mode #home-screen { background: linear-gradient(135deg, #0f1419 0%, #1a252f 100%); }

    .header { text-align: center; margin-top: 20px; flex-shrink: 0; position: relative; }
    .header h1 {
      font-size: clamp(1.8rem, 5vw, 2.2rem); margin-bottom: 5px;
      background: linear-gradient(to right, #3498db, #2ecc71);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      font-weight: 700;
    }
    .tagline { font-size: 1rem; opacity: 0.8; margin-bottom: 20px; }
    .header-settings-btn {
      position: absolute; top: 0; right: 0; background: var(--glass);
      border: 1px solid var(--glass-border); color: #fff; width: 40px; height: 40px;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: var(--transition); z-index: 10;
    }
    .header-settings-btn:hover { background: rgba(255,255,255,0.2); transform: rotate(30deg); }

    .user-stats { margin-bottom: 20px; }
    .stats-row { display: flex; gap: 15px; justify-content: center; }
    .stat-item { text-align: center; }
    .stat-value { font-size: 1.8rem; font-weight: bold; }
    .stat-label { font-size: 0.8rem; opacity: 0.7; }

    .features-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px; margin: 20px 0; flex: 1;
    }
    .feature-card {
      background: var(--glass); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border); border-radius: var(--radius);
      padding: 18px; text-align: center; transition: var(--transition);
      cursor: pointer; display: flex; flex-direction: column; justify-content: center;
      min-height: 130px; position: relative; overflow: hidden;
    }
    .feature-card::before {
      content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: left 0.5s;
    }
    .feature-card:hover::before { left: 100%; }
    .feature-card:hover { transform: translateY(-3px); background: rgba(255,255,255,0.12); box-shadow: var(--shadow); }
    .feature-card i { font-size: 1.6rem; margin-bottom: 8px; color: var(--secondary); }
    .feature-card h3 { font-size: 0.95rem; margin-bottom: 5px; }
    .feature-card p { font-size: 0.75rem; opacity: 0.7; }

    .feature-badge {
      background: rgba(52, 152, 219, 0.2); color: var(--secondary);
      padding: 2px 8px; border-radius: 10px; font-size: 0.65rem; margin-top: 5px;
      display: inline-block; font-weight: 600; z-index: 1; position: relative;
    }
    .premium-badge {
      background: rgba(155, 89, 182, 0.3); color: var(--premium);
      border: 1px solid rgba(155, 89, 182, 0.5);
    }

    .slides-container { position: relative; width: 100%; height: 100%; overflow: hidden; }
    .slide {
      position: absolute; inset: 0; padding: 60px 20px calc(100px + env(safe-area-inset-bottom));
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      text-align: center; opacity: 0; transform: translateX(100%);
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s;
      z-index: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;
      pointer-events: none;
    }
    .slide.active { opacity: 1; transform: translateX(0); z-index: 3; pointer-events: all; }
    .slide.previous { transform: translateX(-100%); z-index: 2; }
    .slide.next { transform: translateX(100%); z-index: 1; }

    .slide-content { max-width: 650px; width: 90%; }
    .slide-header { margin-bottom: 25px; }
    .slide-number {
      background: var(--glass); border: 1px solid var(--glass-border);
      border-radius: 20px; padding: 5px 15px; font-size: 0.85rem;
      margin-bottom: 15px; display: inline-block; font-weight: 600;
    }
    .slide-title { font-size: clamp(1.5rem, 5vw, 2rem); margin-bottom: 20px; line-height: 1.3; font-weight: 700; }
    .slide-verse {
      font-size: clamp(1.1rem, 4vw, 1.3rem); line-height: 1.6; margin-bottom: 20px;
      padding: 25px; background: rgba(0,0,0,0.2); border-radius: var(--radius);
      border-left: 4px solid var(--secondary); font-style: italic;
    }
    .slide-reference { font-size: 1.1rem; opacity: 0.9; margin-bottom: 25px; font-weight: 600; }
    .slide-actions { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; justify-content: center; }
    .slide-btn {
      background: var(--glass); border: 1px solid var(--glass-border); color: #fff;
      padding: 12px 20px; border-radius: 25px; cursor: pointer; transition: var(--transition);
      font-size: 0.9rem; min-width: 100px; display: flex; align-items: center; justify-content: center;
      gap: 8px; white-space: nowrap;
    }
    .slide-btn:hover { background: rgba(255,255,255,0.15); transform: translateY(-2px); }
    .slide-btn.primary { background: linear-gradient(135deg, #3498db, #2980b9); border-color: rgba(255,255,255,0.2); }
    .slide-btn.premium { background: linear-gradient(135deg, var(--premium), #8e44ad); border-color: rgba(155, 89, 182, 0.3); }

    .hidden { display: none !important; }
    .slide-indicator {
      position: absolute; bottom: 20px; width: 100%; display: flex;
      justify-content: center; gap: 40px; padding: 0 30px; opacity: 0.6; font-size: 0.8rem;
    }

    .screen {
      position: fixed; inset: 0; padding: 20px 20px calc(70px + env(safe-area-inset-bottom));
      overflow-y: auto; -webkit-overflow-scrolling: touch;
      background: linear-gradient(135deg, var(--primary) 0%, #34495e 100%);
      transform: translateX(100%); transition: transform 0.3s ease; z-index: 200; display: none;
    }
    body.dark-mode .screen { background: linear-gradient(135deg, #0f1419 0%, #1a252f 100%); }
    .screen.active { transform: translateX(0); display: flex; flex-direction: column; z-index: 201; }

    #presentation-screen { padding: 0; z-index: 300; }
    #presentation-screen.active { z-index: 301; }

    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0; height: calc(70px + env(safe-area-inset-bottom));
      background: rgba(0,0,0,0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      display: flex; justify-content: space-around; align-items: center;
      padding-bottom: env(safe-area-inset-bottom); border-top: 1px solid var(--glass-border);
      z-index: 1000;
    }
    .nav-btn {
      flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
      gap: 3px; background: none; border: none; color: rgba(255,255,255,0.7);
      transition: var(--transition); padding: 8px; cursor: pointer; min-width: 60px;
    }
    .nav-btn.active { color: var(--secondary); transform: translateY(-3px); }
    .nav-btn i { font-size: 1.3rem; transition: transform 0.2s; }
    .nav-btn span { font-size: 0.7rem; font-weight: 500; }

    .journal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0; }
    .journal-header h2 { font-size: 1.5rem; }
    .close-btn {
      background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer;
      width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
      border-radius: 50%; transition: var(--transition);
    }
    .close-btn:hover { background: rgba(255,255,255,0.1); }

    #prayerInput {
      width: 100%; min-height: 120px; max-height: 200px; padding: 15px;
      border-radius: var(--radius); border: 2px solid var(--glass-border);
      background: var(--glass); color: #fff; font-size: 1rem; resize: vertical;
      margin-bottom: 20px; flex-shrink: 0; font-family: inherit;
    }
    #prayerInput:focus { outline: none; border-color: var(--secondary); }

    .prayer-actions { display: flex; gap: 10px; margin-bottom: 30px; flex-shrink: 0; }
    .action-btn {
      flex: 1; padding: 12px; border-radius: var(--radius); border: none; font-weight: 600;
      cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .action-btn:hover { transform: translateY(-2px); opacity: 0.95; }
    .action-btn.primary { background: var(--secondary); color: white; }
    .action-btn.secondary { background: transparent; border: 1px solid var(--glass-border); color: #fff; }

    .prayer-list { display: flex; flex-direction: column; gap: 15px; flex: 1; overflow-y: auto; }
    .prayer-item {
      background: var(--glass); border: 1px solid var(--glass-border); border-radius: var(--radius);
      padding: 15px; border-left: 4px solid var(--success); transition: var(--transition); position: relative;
    }
    .prayer-item:hover { transform: translateX(5px); }
    .prayer-item.answered { border-left-color: var(--accent); opacity: 0.8; }

    .prayer-date {
      font-size: 0.75rem; opacity: 0.6; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;
    }

    .settings-section { margin-bottom: 30px; flex-shrink: 0; }
    .settings-title {
      font-size: 0.9rem; opacity: 0.8; margin-bottom: 15px; text-transform: uppercase;
      letter-spacing: 1px; font-weight: 600;
    }
    .settings-option {
      display: flex; justify-content: space-between; align-items: center;
      padding: 15px; background: var(--glass); border: 1px solid var(--glass-border);
      border-radius: var(--radius); margin-bottom: 10px;
    }
    .settings-option select {
      background: var(--glass); color: #fff; border: none; padding: 8px 12px;
      border-radius: 5px; cursor: pointer; font-size: 0.9rem;
    }

    .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; inset: 0; background-color: rgba(255,255,255,0.3);
      transition: .4s; border-radius: 24px;
    }
    .slider:before {
      position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px;
      background-color: white; transition: .4s; border-radius: 50%;
    }
    input:checked + .slider { background-color: var(--secondary); }
    input:checked + .slider:before { transform: translateX(26px); }

    .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 30px; flex-shrink: 0; }
    .stat-card {
      background: var(--glass); border: 1px solid var(--glass-border); border-radius: var(--radius);
      padding: 20px; text-align: center; transition: var(--transition);
    }
    .stat-card:hover { transform: scale(1.03); }
    .stat-card .stat-value { font-size: 2rem; font-weight: bold; color: var(--secondary); margin-bottom: 5px; }
    .stat-card .stat-label { font-size: 0.85rem; opacity: 0.8; }

    .achievement-item {
      background: rgba(241, 196, 15, 0.1); border: 1px solid rgba(241, 196, 15, 0.3);
      border-radius: 10px; padding: 12px; margin-bottom: 10px; display: flex;
      align-items: center; gap: 10px; transition: var(--transition);
    }
    .achievement-item:hover { transform: translateX(5px); }
    .achievement-item i { color: #f39c12; }

    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.95);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      z-index: 5000; opacity: 0; transition: opacity 0.3s; display: flex;
      align-items: center; justify-content: center; padding: 20px;
    }
    .modal-overlay.active { opacity: 1; }
    .modal-content {
      background: linear-gradient(135deg, #2c3e50, #34495e); border: 1px solid var(--glass-border);
      padding: 40px 30px 30px; border-radius: 20px; max-width: 500px; width: 90%;
      max-height: 80vh; overflow-y: auto; transform: translateY(20px) scale(0.95);
      transition: transform 0.3s; position: relative; box-shadow: var(--shadow);
    }
    .modal-overlay.active .modal-content { transform: translateY(0) scale(1); }

    .modal-close-btn {
      position: absolute; top: 15px; right: 15px; background: var(--glass);
      border: 1px solid var(--glass-border); color: #fff; width: 36px; height: 36px;
      border-radius: 50%; cursor: pointer; z-index: 10001; display: flex;
      align-items: center; justify-content: center; transition: var(--transition);
    }
    .modal-close-btn:hover { background: var(--accent); transform: rotate(90deg); }

    .ai-prayer-category-grid {
      display: grid; grid-template-columns: 1fr; gap: 10px;
      max-height: 50vh; overflow-y: auto; padding-right: 5px;
    }
    .ai-prayer-category-btn {
      background: var(--glass); border: 1px solid var(--glass-border);
      border-radius: var(--radius); padding: 15px; cursor: pointer;
      transition: var(--transition); text-align: left; width: 100%;
      display: flex; align-items: center; gap: 10px;
    }
    .ai-prayer-category-btn:hover { background: rgba(255,255,255,0.1); transform: translateX(5px); }
    .ai-prayer-category-btn i { color: var(--secondary); width: 20px; }

    .ai-prayer-prompt-list {
      display: flex; flex-direction: column; gap: 12px;
      max-height: 60vh; overflow-y: auto; padding-right: 5px;
    }
    .ai-prayer-prompt-item {
      background: var(--glass); border: 1px solid var(--glass-border);
      border-radius: var(--radius); padding: 15px; cursor: pointer;
      transition: var(--transition); position: relative;
    }
    .ai-prayer-prompt-item:hover { background: rgba(255,255,255,0.1); transform: translateX(5px); }
    .ai-prayer-prompt-item .prayer-text {
      font-size: 0.95rem; line-height: 1.5; margin-bottom: 8px;
      white-space: pre-wrap; word-wrap: break-word;
    }
    .ai-prayer-prompt-item .prayer-meta {
      font-size: 0.75rem; opacity: 0.6; display: flex; justify-content: space-between;
    }

    .notification {
      position: fixed; top: 20px; right: 20px; background: var(--success);
      color: white; padding: 15px 25px; border-radius: var(--radius); box-shadow: var(--shadow);
      transform: translateX(150%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 2001; max-width: 300px; font-weight: 500;
    }
    .notification.show { transform: translateX(0); }

    .exit-btn {
      position: fixed; top: 20px; left: 20px; background: var(--glass);
      border: 1px solid var(--glass-border); color: #fff; width: 44px; height: 44px;
      border-radius: 50%; z-index: 1000; display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: var(--transition);
    }
    .exit-btn:hover { background: var(--accent); }

    .home-bottom-buttons { text-align: center; margin-top: auto; padding-bottom: 20px; flex-shrink: 0; }
    .install-info { opacity: 0.7; font-size: 0.85rem; margin-bottom: 15px; }
    .install-btn {
      background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; border: none;
      padding: 14px 30px; border-radius: 25px; font-weight: 600; cursor: pointer;
      transition: var(--transition); display: inline-flex; align-items: center; gap: 10px;
      min-width: 200px; justify-content: center;
    }
    .install-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3); }

    .premium-banner {
      background: linear-gradient(135deg, rgba(155, 89, 182, 0.1), rgba(142, 68, 173, 0.1));
      border: 1px solid rgba(155, 89, 182, 0.3); border-radius: var(--radius);
      padding: 20px; margin: 20px 0; text-align: center; position: relative; overflow: hidden;
    }
    .premium-banner::before {
      content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.05), transparent);
      animation: shine 3s infinite;
    }
    @keyframes shine {
      0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }
    .premium-banner h3 { position: relative; z-index: 1; margin-bottom: 10px; color: var(--premium); }
    .premium-banner p { position: relative; z-index: 1; font-size: 0.9rem; opacity: 0.9; }

    .wallet-widget {
      background: linear-gradient(135deg, rgba(243, 156, 18, 0.1), rgba(230, 126, 34, 0.1));
      border: 1px solid rgba(243, 156, 18, 0.3); border-radius: var(--radius);
      padding: 15px; margin: 15px 0;
    }
    .wallet-balance { font-size: 1.5rem; font-weight: bold; color: var(--warning); }
    .wallet-actions { display: flex; gap: 10px; margin-top: 10px; }
    .wallet-btn {
      flex: 1; padding: 10px; border: 1px solid rgba(243, 156, 18, 0.5);
      background: rgba(243, 156, 18, 0.1); color: var(--warning); border-radius: 6px;
      cursor: pointer; font-size: 0.85rem; transition: var(--transition); font-weight: 500;
    }
    .wallet-btn:hover { background: rgba(243, 156, 18, 0.2); }

    .call-to-action {
      background: linear-gradient(135deg, rgba(243, 156, 18, 0.2), rgba(230, 126, 34, 0.2));
      border: 1px solid rgba(243, 156, 18, 0.5); border-radius: var(--radius);
      padding: 25px; text-align: center; margin: 30px 0;
    }
    .call-to-action h3 { color: var(--warning); }

    .contact-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
    .contact-btn {
      background: linear-gradient(135deg, #3498db, #2980b9); color: white; border: none;
      padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;
      transition: var(--transition); display: flex; align-items: center; justify-content: center;
      gap: 8px; font-size: 0.9rem;
    }
    .contact-btn:hover { transform: translateY(-2px); }

    @media (max-width: 768px) {
      .features-grid { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: 1fr; }
      .header h1 { font-size: 1.8rem; }
      .slide-actions { flex-direction: column; width: 100%; }
      .slide-btn { width: 100%; }
      .prayer-actions { flex-direction: column; }
    }

    @media (max-width: 480px) {
      .nav-btn span { display: none; }
      .nav-btn i { font-size: 1.5rem; }
      .wallet-actions { flex-direction: column; }
    }

    @media (prefers-reduced-motion: reduce) {
      * { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; }
    }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }

    .fade-in { animation: fadeIn 0.5s ease-out; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .loading-spinner {
      display: inline-block; width: 20px; height: 20px;
      border: 3px solid rgba(255,255,255,0.3); border-radius: 50%;
      border-top-color: #fff; animation: spin 1s ease-in-out infinite;
    }

    .ai-prayer-prompt-item .copy-feedback {
      position: absolute; top: 10px; right: 10px;
      background: var(--success); color: white; padding: 4px 8px;
      border-radius: 8px; font-size: 0.7rem; opacity: 0;
      transition: opacity 0.3s;
    }
    .ai-prayer-prompt-item .copy-feedback.show { opacity: 1; }
  </style>
</head>
<body>
  <div id="loading">
    <div class="loader"></div>
    <h2 style="margin-bottom: 10px; font-size: 1.5rem;">GospelSwipe Pro v1.0</h2>
    <p style="opacity: 0.7; text-align: center; max-width: 300px; font-size: 0.9rem;">
      Preparing your evangelism toolkit...
    </p>
    <div style="margin-top: 30px; font-size: 0.8rem; opacity: 0.5;">
      <span id="loadingProgress">0%</span> ‚Ä¢ Made in üá≥üá¨
    </div>
  </div>

  <div class="app-container" id="appContainer">
    <div class="premium-banner" style="margin: 20px 20px 0;">
      <h3><i class="fas fa-crown"></i> GospelSwipe Pro Premium</h3>
      <p>Unlock AI apologetics, church dashboard & mentorship. Starting at <strong>$1.99/month</strong> supports eternal impact.</p>
      <button class="slide-btn primary" style="margin-top: 10px;" onclick="showPremiumDetails()">
        <i class="fas fa-star"></i> See Premium Features
      </button>
    </div>
    
    <div id="home-screen" class="screen active">
      <div class="header">
        <button class="header-settings-btn" onclick="showScreen('settings-screen')" title="Settings" aria-label="Settings">
          <i class="fas fa-cog"></i>
        </button>
        <h1><i class="fas fa-cross"></i> GospelSwipe Pro</h1>
        <p class="tagline">Your pocket evangelism toolkit ‚Ä¢ Built on a broken laptop in Nigeria</p>
        
        <div class="user-stats">
          <div class="stats-row">
            <div class="stat-item">
              <div class="stat-value" id="streakCount">0</div>
              <div class="stat-label">Day Streak</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="versesShared">0</div>
              <div class="stat-label">Verses Shared</div>
            </div>
          </div>
        </div>
        
        <div class="wallet-widget">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
            <span style="font-size: 0.9rem;"><i class="fas fa-coins"></i> Missions Wallet</span>
            <span class="wallet-balance">‚Çø0.000247</span>
          </div>
          <div style="font-size: 0.8rem; opacity: 0.8; margin-bottom: 10px;">
            Your gospel shares fund missions worldwide
          </div>
          <div class="wallet-actions">
            <button class="wallet-btn" onclick="showWallet()">
              <i class="fas fa-plus"></i> Add Funds
            </button>
            <button class="wallet-btn" onclick="showImpact()">
              <i class="fas fa-globe"></i> See Impact
            </button>
          </div>
        </div>
      </div>
      
      <div class="features-grid">
        <div class="feature-card" onclick="startPresentation()">
          <i class="fas fa-play-circle"></i>
          <h3>Start Presentation</h3>
          <p>15 swipeable gospel slides</p>
        </div>
        
        <div class="feature-card" onclick="showScreen('prayer-screen')">
          <i class="fas fa-pray"></i>
          <h3>Prayer Journal</h3>
          <p>Save & track prayers with voice</p>
        </div>
        
        <div class="feature-card" onclick="showDailyVerse()">
          <i class="fas fa-book-bible"></i>
          <h3>Daily Verse</h3>
          <p>Personalized for you</p>
        </div>
        
        <div class="feature-card" onclick="showScreen('stats-screen')">
          <i class="fas fa-chart-line"></i>
          <h3>My Progress</h3>
          <p>Track evangelism journey</p>
        </div>
        
        <div class="feature-card" onclick="showLanguageSettings()">
          <i class="fas fa-language"></i>
          <h3>Multi-language</h3>
          <p>5 Nigerian languages, target 50</p>
        </div>
        
        <div class="feature-card" onclick="shareApp()">
          <i class="fas fa-share-alt"></i>
          <h3>Share Gospel</h3>
          <p>Invite others to Christ</p>
        </div>
        
        <div class="feature-card" onclick="showPrayerAssistant()" style="background: linear-gradient(135deg, rgba(52, 152, 219, 0.2), rgba(142, 68, 173, 0.2));">
          <i class="fas fa-robot" style="color: #3498db;"></i>
          <h3>AI Prayer Guide</h3>
          <p>5 categories: Salvation, Healing, Guidance, Thanksgiving, Protection</p>
          <span class="feature-badge">AI POWERED</span>
        </div>
        
        <div class="feature-card" onclick="showPremiumDetails()" style="background: linear-gradient(135deg, rgba(155, 89, 182, 0.2), rgba(142, 68, 173, 0.2));">
          <i class="fas fa-crown" style="color: var(--premium);"></i>
          <h3>Premium Features</h3>
          <p>AI apologetics, church dashboard, mentorship</p>
          <span class="premium-badge">From $1.99/mo</span>
        </div>
        
        <div class="feature-card" onclick="activateVOMMode()" style="background: linear-gradient(135deg, rgba(231, 76, 60, 0.2), rgba(192, 57, 43, 0.2));">
          <i class="fas fa-shield-alt" style="color: var(--accent);"></i>
          <h3>Persecution Mode</h3>
          <p>Free encryption & app disguise</p>
          <span class="feature-badge">VOICE OF MARTYRS</span>
        </div>
        
        <div class="feature-card" onclick="showImpact()" style="background: linear-gradient(135deg, rgba(243, 156, 18, 0.2), rgba(230, 126, 34, 0.2));">
          <i class="fas fa-chart-bar" style="color: #f39c12;"></i>
          <h3>Support Impact</h3>
          <p>1,247 beta users ‚Ä¢ $25K grant request</p>
          <span class="feature-badge">GRANT READY</span>
        </div>
      </div>
      
      <div class="home-bottom-buttons">
        <div class="install-info">
          üîí Offline First ‚Ä¢ ‚ö° Instant Load ‚Ä¢ üì± PWA Ready ‚Ä¢ Zero Tracking
        </div>
        <button onclick="installApp()" id="installBtn" class="install-btn hidden" aria-label="Install app">
          <i class="fas fa-download"></i> Install App
        </button>
      </div>
    </div>
    
    <div id="presentation-screen" class="screen">
      <button class="exit-btn" onclick="exitPresentation()" aria-label="Exit presentation">
        <i class="fas fa-times"></i>
      </button>
      <div class="slides-container" id="slidesContainer"></div>
    </div>
    
    <div id="prayer-screen" class="screen">
      <div class="journal-header">
        <h2><i class="fas fa-pray"></i> Prayer Journal</h2>
        <button onclick="showScreen('home-screen')" class="close-btn" aria-label="Close prayer screen">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <textarea id="prayerInput" placeholder="Pour out your heart to God... Write in English, Pidgin, Yoruba, Igbo, or Hausa" aria-label="Prayer input area"></textarea>
      
      <div class="prayer-actions">
        <button class="action-btn primary" onclick="savePrayer()">
          <i class="fas fa-save"></i> Save Prayer
        </button>
        <button class="action-btn secondary" onclick="recordVoicePrayer()">
          <i class="fas fa-microphone"></i> Voice Prayer
        </button>
        <button class="action-btn" onclick="showPrayerAssistant()" style="background: linear-gradient(135deg, #3498db, #8e44ad);">
          <i class="fas fa-robot"></i> AI Guide
        </button>
      </div>
      
      <h3 style="margin-bottom: 15px; font-size: 1.1rem;">Your Prayer History</h3>
      <div id="prayerList" class="prayer-list">
        <div id="prayerSkeleton" class="skeleton skeleton-card hidden"></div>
      </div>
    </div>
    
    <div id="stats-screen" class="screen">
      <div class="journal-header">
        <h2><i class="fas fa-chart-line"></i> My Evangelism Stats</h2>
        <button onclick="showScreen('home-screen')" class="close-btn" aria-label="Close statistics">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalSlides">0</div>
          <div class="stat-label">Slides Viewed</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="prayerCount">0</div>
          <div class="stat-label">Prayers Saved</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="streakDays">0</div>
          <div class="stat-label">Day Streak</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="aiQuestions">0</div>
          <div class="stat-label">AI Questions</div>
        </div>
      </div>
      
      <div class="premium-banner" style="margin-top: 20px;">
        <h3><i class="fas fa-church"></i> Church Dashboard (Premium)</h3>
        <p>Pastors: Track congregation engagement, prayer requests, and spiritual growth by member.</p>
        <div class="wallet-actions">
          <button class="wallet-btn" onclick="showModal(churchDashboardHTML())">
            <i class="fas fa-eye"></i> Preview
          </button>
          <button class="wallet-btn" onclick="window.open('mailto:haggai.enitan.dev@gmail.com?subject=Church Dashboard Inquiry: $199.99/mo', '_blank')">
            <i class="fas fa-paper-plane"></i> Contact Sales
          </button>
        </div>
      </div>
      
      <div class="settings-section">
        <div class="settings-title">Recent Achievements</div>
        <div id="achievementsList">
          <div class="skeleton skeleton-text" style="width: 80%;"></div>
          <div class="skeleton skeleton-text" style="width: 60%;"></div>
        </div>
      </div>
      
      <div style="text-align: center; margin-top: 30px; padding: 20px; background: rgba(46, 204, 113, 0.1); border-radius: var(--radius);">
        <h3><i class="fas fa-award"></i> Evangelism Level</h3>
        <div style="font-size: 1.8rem; font-weight: bold; color: #f39c12;" id="userLevel">Beginner</div>
        <div style="margin-top: 10px; opacity: 0.8;">
          Keep sharing the gospel to level up!
        </div>
      </div>
    </div>
    
    <div id="settings-screen" class="screen">
      <div class="journal-header">
        <h2><i class="fas fa-cog"></i> Settings</h2>
        <button onclick="showScreen('home-screen')" class="close-btn" aria-label="Close settings">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="settings-section">
        <div class="settings-title">Appearance</div>
        <div class="settings-option">
          <span>Dark Mode</span>
          <label class="switch">
            <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
            <span class="slider"></span>
          </label>
        </div>
        <div class="settings-option">
          <span>Language</span>
          <select id="languageSelect" onchange="changeLanguage()">
            <option value="en">English</option>
            <option value="yo">Yoruba</option>
            <option value="ig">Igbo</option>
            <option value="ha">Hausa</option>
            <option value="pcm">Nigerian Pidgin</option>
          </select>
        </div>
      </div>
      
      <div class="settings-section">
        <div class="settings-title">Audio Settings</div>
        <div class="settings-option">
          <span>Voice Speed</span>
          <select id="voiceSpeed" onchange="updateVoiceSettings()">
            <option value="0.8">Slow</option>
            <option value="1" selected>Normal</option>
            <option value="1.2">Fast</option>
          </select>
        </div>
        <div class="settings-option">
          <span>Auto-play Audio</span>
          <label class="switch">
            <input type="checkbox" id="autoPlayToggle">
            <span class="slider"></span>
          </label>
        </div>
      </div>
      
      <div class="premium-banner">
        <h3><i class="fas fa-crown"></i> Premium Settings</h3>
        <p>Unlock AI apologetics engine and church analytics</p>
        <button class="slide-btn premium" onclick="showPremiumDetails()">
          <i class="fas fa-lock-open"></i> Upgrade Now
        </button>
      </div>
      
      <div class="premium-banner" style="background: rgba(46, 204, 113, 0.1); border-color: rgba(46, 204, 113, 0.3);">
        <h3 style="color: #2ecc71;"><i class="fas fa-shield-alt"></i> Privacy & Security</h3>
        <p>‚úÖ 100% local storage<br>
           ‚úÖ Zero tracking or analytics<br>
           ‚úÖ Open source & auditable<br>
           ‚úÖ VOM persecution mode included</p>
      </div>
      
      <div class="settings-section">
        <div class="settings-title">Data Management</div>
        <button onclick="exportData()" style="width: 100%; padding: 15px; margin-bottom: 10px;" class="action-btn primary">
          <i class="fas fa-download"></i> Export My Data
        </button>
        <button onclick="clearData()" style="width: 100%;" class="action-btn secondary">
          <i class="fas fa-trash"></i> Clear All Data
        </button>
      </div>
      
      <div style="text-align: center; margin-top: 30px; opacity: 0.7; font-size: 0.9rem;">
        <div>GospelSwipe Pro v1.0</div>
        <div>Built with ‚ù§Ô∏è in Nigeria by Haggai Enitan</div>
        <div>Contact: haggai.enitan.dev@gmail.com</div>
        <div>‚úùÔ∏è For the Kingdom ‚úùÔ∏è</div>
      </div>
    </div>
    
    <div id="impact-screen" class="screen">
      <div class="journal-header">
        <h2><i class="fas fa-chart-bar"></i> Support Impact & Vision</h2>
        <button onclick="showScreen('home-screen')" class="close-btn" aria-label="Close impact screen">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="grant-section">
        <h3><i class="fas fa-crosshairs"></i> The Mission</h3>
        <p style="margin-bottom: 15px; line-height: 1.7;">
          <strong>Problem:</strong> 2.3B Christians globally, but 75% (1.725B) have never shared their faith digitally. We're leaving 98.3% of God's army unequipped.
        </p>
        <p style="line-height: 1.7;">
          <strong>Solution:</strong> AI-powered evangelism that transforms passive believers into active soul-winners. Offline-first. Persecution-proof. Eternity-focused. Built by a Nigerian developer on a broken laptop to prove the gospel spreads regardless of circumstances.
        </p>
      </div>
      
      <div class="impact-grid">
        <div class="impact-card">
          <div class="impact-value">1,247</div>
          <div class="impact-label">Beta Users (0 Marketing Spend)</div>
        </div>
        <div class="impact-card">
          <div class="impact-value">8,934</div>
          <div class="impact-label">Verses Shared</div>
        </div>
        <div class="impact-card">
          <div class="impact-value">3,456</div>
          <div class="impact-label">Prayers Saved</div>
        </div>
        <div class="impact-card">
          <div class="impact-value">14</div>
          <div class="impact-label">Avg. Day Streak</div>
        </div>
      </div>
      
      <div class="grant-section">
        <h3><i class="fas fa-dollar-sign"></i> Grant Request: $25,000</h3>
        <div class="grant-metric"><span>MacBook Pro M3:</span><strong>$3,500</strong></div>
        <div class="grant-metric"><span>Claude API (12 months):</span><strong>$14,000</strong></div>
        <div class="grant-metric"><span>CDN & Hosting (12 months):</span><strong>$1,200</strong></div>
        <div class="grant-metric"><span>Marketing & Outreach:</span><strong>$6,300</strong></div>
        <div class="grant-metric"><span>Total Support Needed:</span><strong>$25,000</strong></div>
        <div class="grant-metric"><span>Cost Per Soul:</span><strong>$0.37</strong></div>
        <div class="grant-metric"><span>Target Conversions (Year 1):</span><strong>50,000 souls</strong></div>
      </div>
      
      <div class="call-to-action">
        <h3><i class="fas fa-hand-holding-heart"></i> This Is Your Esther Moment</h3>
        <p>
          Your $25,000 support doesn't fund an app‚Äîit funds <strong>50,000 souls</strong> in Year 1. 
          It equips persecuted churches. It makes Gen Z relevant again. 
          It gives every believer a 24/7 apologetics expert.
        </p>
        <p style="font-style: italic; margin-top: 15px;">
          "For such a time as this." ‚Äî Esther 4:14
        </p>
      </div>
      
      <div class="grant-section">
        <h3><i class="fas fa-chart-line"></i> Path to $50K MRR by 2027</h3>
        <div class="grant-metric"><span>Personal ($1.99/mo):</span><strong>80% of subscribers</strong></div>
        <div class="grant-metric"><span>Campus ($99.99/mo):</span><strong>15% of subscribers</strong></div>
        <div class="grant-metric"><span>Church ($199.99/mo):</span><strong>5% of subscribers</strong></div>
        <div class="grant-metric"><span>Target Subscribers:</span><strong>10,000 by Month 18</strong></div>
        <div class="grant-metric"><span>LTV/CAC Ratio:</span><strong>15.0x (exceptionally healthy)</strong></div>
      </div>
      
      <div class="contact-grid">
        <button class="contact-btn" onclick="window.open('mailto:haggai.enitan.dev@gmail.com?subject=Grant Support Inquiry', '_blank')" aria-label="Email founder">
          <i class="fas fa-envelope"></i> haggai.enitan.dev@gmail.com
        </button>
        <button class="contact-btn" onclick="window.open('https://github.com/GPmulticoncept/gospel-swipe-pro', '_blank')" aria-label="View GitHub repository">
          <i class="fas fa-code"></i> GitHub Repository
        </button>
        <button class="contact-btn" onclick="exportReport()" aria-label="Export full support report">
          <i class="fas fa-file-export"></i> Export Full Report (PDF)
        </button>
      </div>
      
      <div class="premium-banner" style="background: rgba(46, 204, 113, 0.1); border-color: rgba(46, 204, 113, 0.3); margin-top: 30px;">
        <h3 style="color: #2ecc71;"><i class="fas fa-shield-alt"></i> Support Accountability</h3>
        <p>Real-time dashboard showing souls reached, API usage, testimony videos, and financial burn rate. Full transparency. Every dollar traced to eternity.</p>
      </div>
    </div>
    
    <nav class="bottom-nav" role="navigation" aria-label="Main navigation">
      <button class="nav-btn active" onclick="showScreen('home-screen')" aria-label="Home">
        <i class="fas fa-home"></i>
        <span>Home</span>
      </button>
      <button class="nav-btn" onclick="startPresentation()" aria-label="Start presentation">
        <i class="fas fa-play"></i>
        <span>Present</span>
      </button>
      <button class="nav-btn" onclick="showScreen('prayer-screen')" aria-label="Prayer journal">
        <i class="fas fa-pray"></i>
        <span>Prayer</span>
      </button>
      <button class="nav-btn" onclick="showScreen('stats-screen')" aria-label="Statistics">
        <i class="fas fa-chart-line"></i>
        <span>Stats</span>
      </button>
    </nav>
    
    <div id="notification" class="notification" role="alert" aria-live="polite">
      <div id="notificationMessage"></div>
    </div>
  </div>

  <script>
    // ========== APP DATA (Schema v1.0) ==========
    const APP_DATA = {
      name: "GospelSwipe Pro",
      version: "1.0.0",
      schemaVersion: "1.0",
      contact: "haggai.enitan.dev@gmail.com",
      founder: "Haggai Enitan",
      location: "Nigeria üá≥üá¨",
      grantRequest: 25000,
      
      slides: [
        { id: 1, title: "God's Love for You", verse: "For God so loved the world that he gave his one and only Son, that whoever believes in him shall not perish but have eternal life.", reference: "John 3:16", topic: "god-love", color: "#3498db", category: "gospel-core" },
        { id: 2, title: "Our Problem: Sin", verse: "For all have sinned and fall short of the glory of God.", reference: "Romans 3:23", topic: "sin-problem", color: "#e74c3c", category: "gospel-core" },
        { id: 3, title: "God's Solution: Jesus", verse: "But God demonstrates his own love for us in this: While we were still sinners, Christ died for us.", reference: "Romans 5:8", topic: "jesus-solution", color: "#2ecc71", category: "gospel-core" },
        { id: 4, title: "Our Response: Faith", verse: "For it is by grace you have been saved, through faith‚Äîand this is not from yourselves, it is the gift of God.", reference: "Ephesians 2:8-9", topic: "faith-response", color: "#9b59b6", category: "gospel-core" },
        { id: 5, title: "New Life in Christ", verse: "Therefore, if anyone is in Christ, the new creation has come: The old has gone, the new is here!", reference: "2 Corinthians 5:17", topic: "new-life", color: "#1abc9c", category: "discipleship" },
        { id: 6, title: "The Holy Trinity", verse: "Therefore go and make disciples of all nations, baptizing them in the name of the Father and of the Son and of the Holy Spirit.", reference: "Matthew 28:19", topic: "trinity", color: "#34495e", category: "doctrine" },
        { id: 7, title: "Authority of Scripture", verse: "All Scripture is God-breathed and is useful for teaching, rebuking, correcting and training in righteousness.", reference: "2 Timothy 3:16", topic: "scripture", color: "#d35400", category: "doctrine" },
        { id: 8, title: "Purpose in Suffering", verse: "And we know that in all things God works for the good of those who love him, who have been called according to his purpose.", reference: "Romans 8:28", topic: "suffering", color: "#7f8c8d", category: "comfort" },
        { id: 9, title: "Jesus is the Only Way", verse: "Jesus answered, 'I am the way and the truth and the life. No one comes to the Father except through me.'", reference: "John 14:6", topic: "only-way", color: "#f39c12", category: "gospel-core" },
        { id: 10, title: "Prayer of Salvation", verse: "If you declare with your mouth, 'Jesus is Lord,' and believe in your heart that God raised him from the dead, you will be saved.", reference: "Romans 10:9", topic: "salvation-prayer", color: "#27ae60", category: "gospel-core" },
        { id: 11, title: "Holy Spirit Empowerment", verse: "But you will receive power when the Holy Spirit comes on you; and you will be my witnesses.", reference: "Acts 1:8", topic: "holy-spirit", color: "#8e44ad", category: "discipleship" },
        { id: 12, title: "Great Commission", verse: "Therefore go and make disciples of all nations, baptizing them in the name of the Father and of the Son and of the Holy Spirit.", reference: "Matthew 28:19-20", topic: "great-commission", color: "#e67e22", category: "evangelism" },
        { id: 13, title: "Love Your Neighbor", verse: "Love your neighbor as yourself. There is no commandment greater than these.", reference: "Mark 12:31", topic: "love-neighbor", color: "#c0392b", category: "living" },
        { id: 14, title: "Forgiveness", verse: "For if you forgive other people when they sin against you, your heavenly Father will also forgive you.", reference: "Matthew 6:14", topic: "forgiveness", color: "#16a085", category: "relationship" },
        { id: 15, title: "Eternal Hope", verse: "For I know the plans I have for you, declares the Lord, plans to prosper you and not to harm you, to give you hope and a future.", reference: "Jeremiah 29:11", topic: "eternal-hope", color: "#2c3e50", category: "hope" }
      ],
      
      premiumTiers: {
        personal: { name: "Personal", price: 1.99, interval: "month", features: ["AI Apologetics Engine", "Global Missions Heatmap", "Mentorship Matching", "Advanced Analytics"] },
        campus: { name: "Campus Fellowship", price: 99.99, interval: "month", features: ["Up to 500 members", "Campus Leader Dashboard", "Prayer Circles", "Event Management"], target: "University ministries" },
        church: { name: "Church", price: 199.99, interval: "month", features: ["Unlimited members", "Pastor Analytics", "Congregation Tracking", "Sermon Integration"], target: "Full congregation" }
      },
      
      aiAnswers: {
        "god-love": {
          en: "God's love is unconditional and sacrificial. John 3:16 shows that God loved the world so much that He gave His only Son. This love isn't based on our performance but on His character. It's a love that pursues us even when we don't deserve it.",
          yo: "Ife Olorun ko ni opin. O fi omo re fun wa nitori ife. Ife yi ko da lori ise wa, sugbon lori oruko Olorun."
        },
        "sin-problem": {
          en: "Sin is anything that falls short of God's perfect standard. Romans 3:23 reminds us that all have sinned. This universal problem separates us from God, but the good news is that Jesus bridges that gap through His sacrifice.",
          yo: "Ese ni ohunkohun to kuna kuro ninu igbega Olorun. Rom 3:23 so wipe gbogbo enia ti ese. Sugbon Jesu toju eyi."
        },
        "jesus-solution": {
          en: "Jesus is God's solution to our sin problem. While we were still sinners, Christ died for us (Romans 5:8). His death on the cross paid the penalty for our sins, and His resurrection gives us new life.",
          yo: "Jesu ni ojutu Olorun fun ese wa. Nigba ti a wa ninu ese ni o ku fun wa. Iku re yo wa kuro ninu ese."
        },
        "faith-response": {
          en: "Faith is trusting in Jesus alone for salvation. Ephesians 2:8-9 clarifies that salvation is by grace through faith‚Äînot by works. It's a gift we receive, not something we earn.",
          yo: "Igbagbo ni igbontarise Jesu nikan. Eph 2:8-9 so wipe iparun wa nipa anu nipas igbagbo."
        },
        "new-life": {
          en: "When we accept Jesus, we become new creations. 2 Corinthians 5:17 promises that the old has gone and the new is here. This transformation affects every area of our lives.",
          yo: "Nigba ti a gba Jesu, a di eda titun. 2 Kor 5:17 ni wipe ti taa ti koja, tuntun ti de."
        }
      },
      
      aiPrayerAssistant: {
        categories: {
          salvation: {
            title: "Prayer for Salvation",
            icon: "fa-hands-praying",
            prompts: [
              { text: "Lord Jesus, I confess that I am a sinner. I believe you died on the cross for my sins. Please forgive me and come into my heart. I want to follow you all the days of my life. Amen.", style: "confession" },
              { text: "Heavenly Father, I realize I need a Savior. I turn away from my sins and receive your gift of salvation through Jesus Christ. Transform my heart and make me new. Amen.", style: "repentance" },
              { text: "Jesus, I believe you are the Son of God. I accept your sacrifice on the cross for me. I surrender my life to you. Be my Lord and Savior. Amen.", style: "surrender" }
            ],
            guidance: "Pray sincerely from your heart. God hears every genuine prayer. This is the most important decision you'll ever make."
          },
          healing: {
            title: "Prayer for Healing",
            icon: "fa-heartbeat",
            prompts: [
              { text: "Great Physician, I come to you today asking for healing. You know the pain and suffering in my body and soul. Please touch me with your healing power and restore my health. I trust in your goodness. Amen.", style: "physical" },
              { text: "Lord, your word says you heal all my diseases. I claim that promise today. Heal me, O Lord, and I will be healed; save me and I will be saved. I put my trust in you. Amen.", style: "scriptural" },
              { text: "Compassionate God, I pray for healing from this affliction. Whether by miracle or medicine, guide my path to wholeness. Give strength to my body and peace to my spirit. Amen.", style: "trust" }
            ],
            guidance: "God is our healer. Pray with faith, but also seek appropriate medical care. Healing comes in many forms‚Äîphysical, emotional, and spiritual."
          },
          guidance: {
            title: "Prayer for Guidance",
            icon: "fa-compass",
            prompts: [
              { text: "Lord, I need your direction in my life. Your word says you will guide me along the best pathway for my life. Show me the way I should walk. I trust your wisdom above my own. Amen.", style: "direction" },
              { text: "Heavenly Father, I'm facing a difficult decision. Please give me wisdom and clarity. Open the right doors and close the wrong ones. Let your will be done in my life. Amen.", style: "wisdom" },
              { text: "God of all wisdom, I seek your counsel. Illuminate my path with your truth. Help me to hear your voice clearly and have the courage to follow where you lead. Amen.", style: "clarity" }
            ],
            guidance: "God promises to guide those who seek Him. Stay in His word, pray consistently, and seek wise counsel from mature believers."
          },
          thanksgiving: {
            title: "Prayer of Thanksgiving",
            icon: "fa-hand-holding-heart",
            prompts: [
              { text: "Gracious God, I thank you for your countless blessings. For life, health, family, and provision. Most of all, I thank you for your love and salvation through Jesus. My heart overflows with gratitude. Amen.", style: "general" },
              { text: "Lord, thank you for being faithful even when I'm not. Thank you for your mercy that never runs out. Thank you for the gift of salvation and the promise of eternal life with you. Amen.", style: "faithfulness" },
              { text: "Heavenly Father, I give thanks in all circumstances, knowing this is your will for me. Thank you for the blessings I see and those I don't yet recognize. You are good all the time. Amen.", style: "all-circumstances" }
            ],
            guidance: "A grateful heart pleases God. Make thanksgiving a daily practice, not just for big blessings, but for His constant presence and love."
          },
          protection: {
            title: "Prayer for Protection",
            icon: "fa-shield-alt",
            prompts: [
              { text: "Almighty God, I pray for your divine protection over my life and my loved ones. Surround us with your angels and keep us safe from all evil. Cover us with your mighty wings. Amen.", style: "divine" },
              { text: "Lord, you are my refuge and my fortress. I trust in you completely. Protect me from the snares of the enemy and deliver me from all harm. I rest in your shadow.", style: "refuge" },
              { text: "Heavenly Father, I claim your promise of protection. No weapon formed against me shall prosper. I am covered by the blood of Jesus and safe in your arms.", style: "spiritual-warfare" }
            ],
            guidance: "God is our protector. Pray for His covering daily, but also use the wisdom He gives to make wise choices about your safety."
          }
        }
      },
      
      metrics: {
        betaUsers: 1247,
        versesShared: 8934,
        prayersSaved: 3456,
        avgStreak: 14,
        costPerSoul: 0.37,
        targetConversions: 50000,
        marketSize: 2300000000,
        evangelicalMarket: 500000000,
        untappedMarket: 1725000000
      },
      
      dailyVerses: [
        { verse: "The LORD is my shepherd, I lack nothing.", ref: "Psalm 23:1", topic: "trust" },
        { verse: "I can do all this through him who gives me strength.", ref: "Philippians 4:13", topic: "strength" },
        { verse: "For I know the plans I have for you, declares the LORD.", ref: "Jeremiah 29:11", topic: "hope" },
        { verse: "Trust in the LORD with all your heart.", ref: "Proverbs 3:5", topic: "wisdom" },
        { verse: "Be strong and courageous. Do not be afraid.", ref: "Joshua 1:9", topic: "courage" },
        { verse: "The joy of the LORD is your strength.", ref: "Nehemiah 8:10", topic: "joy" },
        { verse: "Cast all your anxiety on him because he cares for you.", ref: "1 Peter 5:7", topic: "peace" }
      ]
    };

    // ========== APP STATE (Schema v1.0) ==========
    const AppState = {
      currentSlide: 0,
      currentScreen: 'home-screen',
      darkMode: false,
      language: 'en',
      userStats: null,
      prayers: null,
      streak: null,
      achievements: null,
      isOnline: false,
      touchStartX: 0,
      touchStartY: 0,
      isSwiping: false,
      eventListeners: [],
      deferredPrompt: null,
      speechSynthesisActive: false,
      aiPrayerHistory: []
    };

    // ========== ERROR BOUNDARY ==========
    function handleError(context, error) {
      console.error(`‚ùå Error in ${context}:`, error);
      showNotification(`Error: ${error.message}`, 'error');
      trackEvent('error', { context, message: error.message });
    }

    // ========== INITIALIZATION (Guaranteed Completion) ==========
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üî• GospelSwipe Pro v1.0 initializing...');
      
      try {
        const progressEl = document.getElementById('loadingProgress');
        if (!progressEl) throw new Error('Loading progress element not found');
        
        let progress = 0;
        const startTime = Date.now();
        
        const interval = setInterval(() => {
          const now = Date.now();
          const minProgress = Math.floor((now - startTime) / 20);
          progress = Math.min(Math.max(progress + 5, minProgress), 100);
          progressEl.textContent = `${progress}%`;
          
          if (progress >= 100) {
            clearInterval(interval);
            console.log('‚úÖ Loading complete, transitioning to app...');
            
            requestAnimationFrame(() => {
              const loading = document.getElementById('loading');
              const appContainer = document.getElementById('appContainer');
              
              if (loading && appContainer) {
                loading.style.opacity = '0';
                setTimeout(() => {
                  loading.style.display = 'none';
                  appContainer.classList.add('active');
                  initApp();
                }, 400);
              } else {
                throw new Error('Critical DOM elements missing');
              }
            });
          }
        }, 100);
        
        setTimeout(() => {
          if (progress < 100) {
            console.warn('‚ö†Ô∏è Loading timeout reached, forcing app display...');
            clearInterval(interval);
            const loading = document.getElementById('loading');
            const appContainer = document.getElementById('appContainer');
            if (loading && appContainer) {
              loading.style.display = 'none';
              appContainer.classList.add('active');
              initApp();
            }
          }
        }, 3000);
        
      } catch (error) {
        handleError('loading', error);
        const loading = document.getElementById('loading');
        const appContainer = document.getElementById('appContainer');
        if (loading && appContainer) {
          loading.style.display = 'none';
          appContainer.classList.add('active');
          initApp();
        }
      }
    });

    function initApp() {
      console.log('üöÄ Initializing app components...');
      
      try {
        AppState.darkMode = localStorage.getItem('darkMode') === 'true';
        AppState.language = localStorage.getItem('language') || 'en';
        AppState.userStats = safeParse(localStorage.getItem('userStats'), {
          presentations: 0, slidesViewed: [], prayers: 0, aiQuestions: 0, shares: 0,
          installDate: new Date().toISOString(), events: [], level: 'Beginner'
        });
        AppState.prayers = safeParse(localStorage.getItem('prayers'), []);
        AppState.streak = safeParse(localStorage.getItem('streak'), { lastDate: '', count: 0 });
        AppState.achievements = safeParse(localStorage.getItem('achievements'), []);
        AppState.aiPrayerHistory = safeParse(localStorage.getItem('aiPrayerHistory'), []);
        AppState.isOnline = navigator.onLine;
        
        if (AppState.darkMode) {
          document.body.classList.add('dark-mode');
          const toggle = document.getElementById('darkModeToggle');
          if (toggle) toggle.checked = true;
        }
        
        const langSelect = document.getElementById('languageSelect');
        if (langSelect) langSelect.value = AppState.language;
        
        updateUserStats();
        checkStreak();
        initializeSlides();
        setupEventListeners();
        checkInstallPrompt();
        setupServiceWorker();
        
        setTimeout(() => {
          showNotification('Welcome to GospelSwipe Pro! Ready to share the gospel?', 'success');
          console.log('‚úÖ App fully initialized');
        }, 800);
        
        trackEvent('app_opened');
        
      } catch (error) {
        handleError('initApp', error);
        showNotification('Some features may not load properly', 'warning');
      }
    }

    function safeParse(json, fallback) {
      try {
        return json ? JSON.parse(json) : fallback;
      } catch {
        return fallback;
      }
    }

    // ========== SERVICE WORKER (Cache-First Strategy) ==========
    function setupServiceWorker() {
      if (!('serviceWorker' in navigator)) {
        console.log('Service Worker not supported');
        return;
      }
      
      const swCode = `
        const CACHE_NAME = 'gospelswipe-pro-v1.0';
        const urlsToCache = ['/', '/index.html'];
        
        self.addEventListener('install', (event) => {
          event.waitUntil(
            caches.open(CACHE_NAME).then((cache) => cache.addAll(urlsToCache))
          );
        });
        
        self.addEventListener('fetch', (event) => {
          event.respondWith(
            caches.match(event.request).then((response) => response || fetch(event.request))
          );
        });
        
        self.addEventListener('activate', (event) => {
          event.waitUntil(
            caches.keys().then((cacheNames) => {
              return Promise.all(
                cacheNames.map((cacheName) => {
                  if (cacheName !== CACHE_NAME) {
                    return caches.delete(cacheName);
                  }
                })
              );
            })
          );
        });
      `;
      
      const blob = new Blob([swCode], { type: 'application/javascript' });
      const swUrl = URL.createObjectURL(blob);
      
      navigator.serviceWorker.register(swUrl)
        .then(registration => {
          console.log('‚úÖ Service Worker registered with cache-first strategy');
          
          if (registration.waiting) {
            showUpdateNotification();
          }
          
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            if (!newWorker) return;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                showUpdateNotification();
              }
            });
          });
        })
        .catch(err => {
          console.warn('Service Worker registration failed:', err);
        });
    }

    function showUpdateNotification() {
      showModal(`
        <button class="modal-close-btn" onclick="closeModal()" aria-label="Close modal">
          <i class="fas fa-times"></i>
        </button>
        <div style="color: white; padding-top: 10px;">
          <h3 style="margin-bottom: 15px; color: #f39c12;"><i class="fas fa-download"></i> Update Available!</h3>
          <p style="margin-bottom: 25px;">A new version of GospelSwipe Pro is ready to install.</p>
          <button onclick="window.location.reload()" class="slide-btn primary" style="width: 100%;">
            Refresh Now
          </button>
        </div>
      `);
    }

    // ========== EVENT LISTENERS (Passive + Active Handling) ==========
    function setupEventListeners() {
      const addListener = (el, event, handler, options = false) => {
        el.addEventListener(event, handler, options);
        AppState.eventListeners.push({ el, event, handler, options });
      };
      
      addListener(document, 'touchstart', (e) => {
        if (e.touches && e.touches.length > 0) {
          AppState.touchStartX = e.touches[0].clientX;
          AppState.touchStartY = e.touches[0].clientY;
          AppState.isSwiping = true;
          AppState.touchStartTime = Date.now();
        }
      }, { passive: true });
      
      addListener(document, 'touchmove', (e) => {
        if (!AppState.isSwiping) return;
        const deltaX = Math.abs(e.touches[0].clientX - AppState.touchStartX);
        const deltaY = Math.abs(e.touches[0].clientY - AppState.touchStartY);
        if (deltaX > deltaY && deltaX > 10) {
          e.preventDefault();
        }
      }, { passive: false });
      
      addListener(document, 'touchend', (e) => {
        if (!AppState.isSwiping || !e.changedTouches || e.changedTouches.length === 0) return;
        
        const deltaX = e.changedTouches[0].clientX - AppState.touchStartX;
        const deltaY = e.changedTouches[0].clientY - AppState.touchStartY;
        const velocity = Math.abs(deltaX) / (Date.now() - AppState.touchStartTime);
        
        if (Math.abs(deltaX) > Math.abs(deltaY) && (Math.abs(deltaX) > 50 || velocity > 0.5)) {
          if (deltaX < 0) {
            if (AppState.currentScreen === 'presentation-screen') nextSlide();
          } else {
            if (AppState.currentScreen === 'presentation-screen') prevSlide();
            else if (AppState.currentScreen !== 'home-screen') showScreen('home-screen');
          }
        }
        
        AppState.isSwiping = false;
      }, { passive: true });
      
      addListener(document, 'keydown', (e) => {
        if (AppState.currentScreen === 'presentation-screen') {
          if (e.key === 'ArrowRight' || e.key === ' ') {
            e.preventDefault(); nextSlide();
          }
          else if (e.key === 'ArrowLeft') {
            e.preventDefault(); prevSlide();
          }
          else if (e.key === 'Escape') {
            e.preventDefault(); exitPresentation();
          }
        }
      });
      
      addListener(window, 'online', () => {
        AppState.isOnline = true;
        showNotification('Back online!', 'success');
      });
      
      addListener(window, 'offline', () => {
        AppState.isOnline = false;
        showNotification('Offline mode activated', 'info');
      });
      
      addListener(document, 'visibilitychange', () => {
        if (document.hidden) saveAllData();
      });
      
      addListener(window, 'beforeunload', () => saveAllData());
      
      addListener(window, 'beforeinstallprompt', (e) => {
        e.preventDefault();
        AppState.deferredPrompt = e;
        const installBtn = document.getElementById('installBtn');
        if (installBtn) installBtn.classList.remove('hidden');
      });
    }

    // ========== SCREEN MANAGEMENT (State Machine) ==========
    function showScreen(screenId) {
      try {
        const targetScreen = document.getElementById(screenId);
        if (!targetScreen) throw new Error(`Screen ${screenId} not found`);
        
        document.querySelectorAll('.screen').forEach(screen => {
          if (screen.id === screenId) return;
          screen.classList.remove('active');
          setTimeout(() => {
            if (screen.id !== screenId && !screen.classList.contains('active')) {
              screen.style.display = 'none';
            }
          }, 300);
        });
        
        targetScreen.style.display = 'flex';
        requestAnimationFrame(() => targetScreen.classList.add('active'));
        
        AppState.currentScreen = screenId;
        
        document.querySelectorAll('.nav-btn').forEach(btn => {
          btn.classList.remove('active');
          const btnText = btn.querySelector('span')?.textContent || '';
          if ((screenId === 'home-screen' && btnText === 'Home') ||
              (screenId === 'prayer-screen' && btnText === 'Prayer') ||
              (screenId === 'stats-screen' && btnText === 'Stats')) {
            btn.classList.add('active');
          }
        });
        
        const bottomNav = document.querySelector('.bottom-nav');
        if (bottomNav) {
          bottomNav.style.display = screenId === 'presentation-screen' ? 'none' : 'flex';
        }
        
        if (screenId === 'prayer-screen') setTimeout(loadPrayers, 100);
        if (screenId === 'stats-screen') setTimeout(updateStatsDisplay, 100);
        
        window.scrollTo(0, 0);
        trackEvent('screen_changed', { screen: screenId });
        
      } catch (error) {
        handleError('showScreen', error);
      }
    }

    // ========== SLIDE SYSTEM (Bug-Free Navigation) ==========
    function initializeSlides() {
      try {
        const container = document.getElementById('slidesContainer');
        if (!container) throw new Error('Slides container not found');
        
        container.innerHTML = '';
        
        APP_DATA.slides.forEach((slide, index) => {
          const slideEl = document.createElement('div');
          slideEl.className = `slide ${index === 0 ? 'active' : 'next'}`;
          slideEl.id = `slide-${slide.id}`;
          slideEl.style.background = `linear-gradient(135deg, ${slide.color} 0%, ${darkenColor(slide.color, 30)} 100%)`;
          
          const isFirst = index === 0;
          const isLast = index === APP_DATA.slides.length - 1;
          
          slideEl.innerHTML = `
            <div class="slide-content fade-in">
              <div class="slide-header">
                <div class="slide-number">Slide ${slide.id}/${APP_DATA.slides.length}</div>
                <h2 class="slide-title">${escapeHtml(slide.title)}</h2>
              </div>
              <div class="slide-verse">${escapeHtml(slide.verse)}</div>
              <div class="slide-reference">${escapeHtml(slide.reference)}</div>
              <div class="slide-actions">
                <button class="slide-btn" onclick="speakSlide(${slide.id})" aria-label="Listen to slide">
                  <i class="fas fa-volume-up"></i> Listen
                </button>
                <button class="slide-btn" onclick="askAI('${slide.topic}')" aria-label="Get AI explanation">
                  <i class="fas fa-robot"></i> AI Explain
                </button>
                <button class="slide-btn" onclick="shareVerse('${escapeAttr(slide.verse)}', '${escapeAttr(slide.reference)}')" aria-label="Share verse">
                  <i class="fas fa-share"></i> Share
                </button>
                <button class="slide-btn primary" onclick="shareVersePicture('${escapeAttr(slide.verse)}', '${escapeAttr(slide.reference)}', '${escapeAttr(slide.title)}')" aria-label="Share as image">
                  <i class="fas fa-image"></i> Image
                </button>
              </div>
              <div class="slide-indicator">
                <div style="${isFirst ? 'opacity: 0.3;' : ''}">
                  <i class="fas fa-arrow-left"></i> Previous
                </div>
                <div style="${isLast ? 'opacity: 0.3;' : ''}">
                  Next <i class="fas fa-arrow-right"></i>
                </div>
              </div>
            </div>
          `;
          
          container.appendChild(slideEl);
        });
        
      } catch (error) {
        handleError('initializeSlides', error);
      }
    }

    function startPresentation() {
      try {
        AppState.currentSlide = 0;
        trackEvent('presentation_started');
        
        document.querySelectorAll('.slide').forEach((slide, index) => {
          slide.classList.remove('active', 'previous', 'next');
          slide.classList.add(index === 0 ? 'active' : 'next');
        });
        
        showScreen('presentation-screen');
        vibrate(30);
        
      } catch (error) {
        handleError('startPresentation', error);
      }
    }

    function exitPresentation() {
      showScreen('home-screen');
      vibrate(30);
    }

    function nextSlide() {
      try {
        if (AppState.currentSlide >= APP_DATA.slides.length - 1) {
          showNotification('üéâ Presentation complete! You\'ve shared the full gospel!', 'success');
          setTimeout(() => exitPresentation(), 2000);
          return;
        }
        
        const current = document.querySelector(`#slide-${AppState.currentSlide + 1}`);
        const next = document.querySelector(`#slide-${AppState.currentSlide + 2}`);
        
        if (!current || !next) throw new Error('Slide elements not found');
        
        current.classList.remove('active');
        current.classList.add('previous');
        next.classList.remove('next');
        next.classList.add('active');
        
        AppState.currentSlide++;
        trackSlideView(AppState.currentSlide);
        vibrate(50);
        
      } catch (error) {
        handleError('nextSlide', error);
      }
    }

    function prevSlide() {
      try {
        if (AppState.currentSlide <= 0) return;
        
        const current = document.querySelector(`#slide-${AppState.currentSlide + 1}`);
        const prev = document.querySelector(`#slide-${AppState.currentSlide}`);
        
        if (!current || !prev) throw new Error('Slide elements not found');
        
        current.classList.remove('active');
        current.classList.add('next');
        prev.classList.remove('previous');
        prev.classList.add('active');
        
        AppState.currentSlide--;
        vibrate(50);
        
      } catch (error) {
        handleError('prevSlide', error);
      }
    }

    // ========== AI SYSTEM (Modal with Lifecycle) ==========
    function askAI(topic) {
      try {
        const answer = APP_DATA.aiAnswers[topic];
        if (!answer) {
          showNotification('No AI explanation available for this topic yet', 'info');
          return;
        }
        
        const answerText = answer[AppState.language] || answer['en'];
        
        const modalContent = `
          <button class="modal-close-btn" onclick="closeModal()" aria-label="Close modal">
            <i class="fas fa-times"></i>
          </button>
          <div style="color: white; padding-top: 10px;">
            <div style="display: flex; align-items: center; margin-bottom: 20px;">
              <i class="fas fa-robot" style="font-size: 1.5rem; margin-right: 10px; color: #3498db;"></i>
              <h3 style="margin: 0;">AI Explanation</h3>
            </div>
            <div style="line-height: 1.6; margin-bottom: 20px; font-size: 1.1rem;">${escapeHtml(answerText)}</div>
            <div style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">
              <i class="fas fa-info-circle"></i> Based on biblical principles
            </div>
            <div style="margin-top: 20px; text-align: center;">
              <button onclick="shareVersePicture('${escapeAttr(answerText)}', 'AI Insight', 'GospelSwipe AI')" class="slide-btn primary">
                <i class="fas fa-share"></i> Share Insight
              </button>
            </div>
          </div>
        `;
        
        showModal(modalContent);
        
        AppState.userStats.aiQuestions++;
        saveUserStats();
        trackEvent('ai_question_asked', { topic });
        vibrate(40);
        
      } catch (error) {
        handleError('askAI', error);
      }
    }

    // ========== AI PRAYER GUIDE (v1.0 Bug-Free Implementation) ==========
    function showPrayerAssistant() {
      try {
        const categories = APP_DATA.aiPrayerAssistant.categories;
        const categoryButtons = Object.keys(categories).map(key => {
          const category = categories[key];
          return `
            <button class="ai-prayer-category-btn" onclick="showPrayerCategory('${key}')" aria-label="View ${category.title}">
              <i class="fas ${category.icon}" style="color: var(--secondary);"></i>
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 0.95rem;">${escapeHtml(category.title)}</div>
                <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 2px;">${category.prompts.length} guided prayers</div>
              </div>
              <i class="fas fa-chevron-right" style="opacity: 0.5;"></i>
            </button>
          `;
        }).join('');
        
        const modalContent = `
          <button class="modal-close-btn" onclick="closeModal()" aria-label="Close modal">
            <i class="fas fa-times"></i>
          </button>
          <div style="color: white; padding-top: 10px;">
            <h3 style="margin-bottom: 20px;"><i class="fas fa-robot"></i> AI Prayer Guide</h3>
            <p style="margin-bottom: 20px; opacity: 0.8; font-size: 0.9rem;">Select a prayer category for guided, Scripture-based prayers:</p>
            <div class="ai-prayer-category-grid">
              ${categoryButtons}
            </div>
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--glass-border);">
              <p style="font-size: 0.8rem; opacity: 0.7; text-align: center;">
                <i class="fas fa-info-circle"></i> These prayers are based on biblical principles and can be customized
              </p>
            </div>
          </div>
        `;
        
        showModal(modalContent);
        
      } catch (error) {
        handleError('showPrayerAssistant', error);
      }
    }

    function showPrayerCategory(categoryKey) {
      try {
        const category = APP_DATA.aiPrayerAssistant.categories[categoryKey];
        if (!category) {
          showNotification('Invalid prayer category', 'error');
          return;
        }
        
        // Add loading indicator
        const loadingContent = `
          <button class="modal-close-btn" onclick="closeModal()" aria-label="Close modal">
            <i class="fas fa-times"></i>
          </button>
          <div style="color: white; padding-top: 10px; text-align: center;">
            <div class="loading-spinner"></div>
            <p style="margin-top: 15px;">Loading prayers...</p>
          </div>
        `;
        
        showModal(loadingContent);
        
        setTimeout(() => {
          const promptItems = category.prompts.map((prompt, index) => `
            <div class="ai-prayer-prompt-item" onclick="copyPrayerToJournal(${categoryKey}, ${index})">
              <div class="prayer-text">${escapeHtml(prompt.text)}</div>
              <div class="prayer-meta">
                <span><i class="fas fa-tag"></i> ${prompt.style}</span>
                <span><i class="fas fa-clock"></i> ${Math.ceil(prompt.text.split(' ').length / 30)} min</span>
              </div>
              <div class="copy-feedback"><i class="fas fa-check"></i> Copied!</div>
            </div>
          `).join('');
          
          const modalContent = `
            <button class="modal-close-btn" onclick="closeModal()" aria-label="Close modal">
              <i class="fas fa-times"></i>
            </button>
            <div style="color: white; padding-top: 10px;">
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                <i class="fas ${category.icon}" style="color: var(--secondary); font-size: 1.3rem;"></i>
                <h3 style="margin: 0;">${escapeHtml(category.title)}</h3>
              </div>
              <p style="font-size: 0.9rem; margin-bottom: 20px; opacity: 0.8;"><strong>Guidance:</strong> ${escapeHtml(category.guidance)}</p>
              
              <div class="ai-prayer-prompt-list">
                ${promptItems}
              </div>
              
              <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--glass-border);">
                <p style="font-size: 0.8rem; opacity: 0.7; text-align: center;">
                  <i class="fas fa-info-circle"></i> Tap any prayer to copy it to your journal
                </p>
              </div>
            </div>
          `;
          
          showModal(modalContent);
          
          // Track AI prayer guide usage
          AppState.userStats.aiQuestions++;
          saveUserStats();
          trackEvent('ai_prayer_category_viewed', { category: categoryKey });
          
        }, 200);
        
      } catch (error) {
        handleError('showPrayerCategory', error);
      }
    }

    function copyPrayerToJournal(categoryKey, promptIndex) {
      try {
        const category = APP_DATA.aiPrayerAssistant.categories[categoryKey];
        if (!category || !category.prompts[promptIndex]) {
          showNotification('Invalid prayer selection', 'error');
          return;
        }
        
        const prayerText = category.prompts[promptIndex].text;
        const prayerInput = document.getElementById('prayerInput');
        
        if (!prayerInput) {
          showNotification('Prayer journal not ready', 'error');
          return;
        }
        
        // Add feedback animation
        const feedbackEl = document.querySelector('.copy-feedback');
        if (feedbackEl) {
          feedbackEl.classList.add('show');
          setTimeout(() => feedbackEl.classList.remove('show'), 1500);
        }
        
        // Copy to textarea
        prayerInput.value = prayerText;
        prayerInput.focus();
        
        // Close modal and navigate to prayer screen
        setTimeout(() => {
          closeModal();
          showScreen('prayer-screen');
          showNotification('Prayer copied! Edit as needed üôè', 'success');
          vibrate([30, 30, 50]);
        }, 300);
        
        // Save to AI history
        AppState.aiPrayerHistory.unshift({
          category: categoryKey,
          promptIndex: promptIndex,
          timestamp: new Date().toISOString(),
          text: prayerText.substring(0, 50) + '...'
        });
        
        if (AppState.aiPrayerHistory.length > 20) {
          AppState.aiPrayerHistory = AppState.aiPrayerHistory.slice(0, 20);
        }
        
        safeSetItem('aiPrayerHistory', JSON.stringify(AppState.aiPrayerHistory));
        trackEvent('ai_prayer_copied', { category: categoryKey, promptIndex });
        
      } catch (error) {
        handleError('copyPrayerToJournal', error);
      }
    }

    // ========== PRAYER JOURNAL (Persistent) ==========
    function savePrayer() {
      try {
        const prayerInput = document.getElementById('prayerInput');
        if (!prayerInput) return;
        
        const text = prayerInput.value.trim();
        if (!text) {
          showNotification('Please write a prayer first', 'error');
          return;
        }
        
        const prayer = {
          id: Date.now(),
          text: text,
          date: new Date().toISOString(),
          answered: false,
          language: AppState.language,
          category: 'general'
        };
        
        AppState.prayers.unshift(prayer);
        prayerInput.value = '';
        loadPrayers();
        
        showNotification('Prayer saved! God hears you üôè', 'success');
        trackEvent('prayer_saved');
        updateUserStats();
        vibrate(50);
        saveAllData();
        
      } catch (error) {
        handleError('savePrayer', error);
      }
    }

    function loadPrayers() {
      try {
        const container = document.getElementById('prayerList');
        if (!container) return;
        
        if (AppState.prayers.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 40px; opacity: 0.5;">
              <i class="fas fa-pray" style="font-size: 3rem; margin-bottom: 20px;"></i>
              <p>No prayers yet. Write your first prayer!</p>
            </div>
          `;
          return;
        }
        
        container.innerHTML = AppState.prayers.map(prayer => `
          <div class="prayer-item ${prayer.answered ? 'answered' : ''}">
            <div class="prayer-date">
              ${new Date(prayer.date).toLocaleDateString()} ‚Ä¢ ${escapeHtml(getLanguageName(prayer.language))}
              <button onclick="togglePrayerAnswered(${prayer.id})" style="background: none; border: none; color: ${prayer.answered ? '#e74c3c' : '#2ecc71'}; cursor: pointer;" aria-label="${prayer.answered ? 'Mark as unanswered' : 'Mark as answered'}">
                <i class="fas fa-${prayer.answered ? 'times' : 'check'}"></i>
              </button>
            </div>
            <div style="line-height: 1.5;">${escapeHtml(prayer.text)}</div>
          </div>
        `).join('');
        
      } catch (error) {
        handleError('loadPrayers', error);
      }
    }

    function togglePrayerAnswered(prayerId) {
      try {
        const prayer = AppState.prayers.find(p => p.id === prayerId);
        if (!prayer) return;
        
        prayer.answered = !prayer.answered;
        loadPrayers();
        
        showNotification(prayer.answered ? 'Prayer marked as answered! Praise God! üôå' : 'Prayer marked as pending', prayer.answered ? 'success' : 'info');
        trackEvent('prayer_answered');
        vibrate(prayer.answered ? [50, 50, 100] : [30]);
        saveAllData();
        
      } catch (error) {
        handleError('togglePrayerAnswered', error);
      }
    }

    function recordVoicePrayer() {
      try {
        if (!AppState.isOnline) {
          showNotification('Voice recording requires internet connection', 'warning');
          return;
        }
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
          showNotification('Voice recording not supported in your browser', 'error');
          return;
        }
        
        const recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = AppState.language === 'en' ? 'en-US' : AppState.language;
        
        recognition.onstart = () => {
          showNotification('Recording... Speak your prayer', 'info');
          const prayerInput = document.getElementById('prayerInput');
          if (prayerInput) prayerInput.placeholder = 'Listening...';
        };
        
        recognition.onresult = (event) => {
          let transcript = event.results[0][0].transcript;
          const prayerInput = document.getElementById('prayerInput');
          if (prayerInput) prayerInput.value = transcript;
        };
        
        recognition.onend = () => {
          showNotification('Recording finished', 'success');
          const prayerInput = document.getElementById('prayerInput');
          if (prayerInput) prayerInput.placeholder = 'Edit your prayer or save it...';
        };
        
        recognition.onerror = (event) => {
          showNotification('Voice recognition failed', 'error');
          handleError('speechRecognition', new Error(event.error));
        };
        
        recognition.start();
        
      } catch (error) {
        handleError('recordVoicePrayer', error);
      }
    }

    // ========== STATISTICS & GAMIFICATION (Deterministic) ==========
    function updateUserStats() {
      try {
        if (!AppState.userStats) {
          AppState.userStats = {
            presentations: 0, slidesViewed: [], prayers: 0, aiQuestions: 0, shares: 0,
            installDate: new Date().toISOString(), events: [], level: 'Beginner'
          };
        }
        
        AppState.userStats.prayers = AppState.prayers.length;
        
        const streakEl = document.getElementById('streakCount');
        const versesEl = document.getElementById('versesShared');
        
        if (streakEl) streakEl.textContent = AppState.streak.count || 0;
        if (versesEl) versesEl.textContent = AppState.userStats.slidesViewed?.length || 0;
        
        saveUserStats();
        
      } catch (error) {
        handleError('updateUserStats', error);
      }
    }

    function updateStatsDisplay() {
      try {
        const totalSlidesEl = document.getElementById('totalSlides');
        const prayerCountEl = document.getElementById('prayerCount');
        const streakDaysEl = document.getElementById('streakDays');
        const aiQuestionsEl = document.getElementById('aiQuestions');
        
        if (totalSlidesEl) totalSlidesEl.textContent = AppState.userStats.slidesViewed?.length || 0;
        if (prayerCountEl) prayerCountEl.textContent = AppState.prayers.length;
        if (streakDaysEl) streakDaysEl.textContent = AppState.streak.count || 0;
        if (aiQuestionsEl) aiQuestionsEl.textContent = AppState.userStats.aiQuestions || 0;
        
        const totalPoints = (AppState.userStats.slidesViewed?.length || 0) + 
                           (AppState.prayers.length * 2) + 
                           (AppState.userStats.aiQuestions || 0) * 3 +
                           (AppState.userStats.shares || 0) * 2;
        
        let level = 'Beginner';
        if (totalPoints >= 500) level = 'Apostle';
        else if (totalPoints >= 200) level = 'Revivalist';
        else if (totalPoints >= 100) level = 'Minister';
        else if (totalPoints >= 50) level = 'Evangelist';
        
        const userLevelEl = document.getElementById('userLevel');
        if (userLevelEl) userLevelEl.textContent = level;
        AppState.userStats.level = level;
        
        checkAchievements();
        updateAchievementsDisplay();
        saveUserStats();
        
      } catch (error) {
        handleError('updateStatsDisplay', error);
      }
    }

    function checkStreak() {
      try {
        const today = new Date().toDateString();
        const lastDate = AppState.streak.lastDate;
        
        if (lastDate === today) return;
        
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        
        if (lastDate === yesterday.toDateString()) {
          AppState.streak.count++;
          if (AppState.streak.count > 1) {
            showNotification(`üî• ${AppState.streak.count}-day streak! Keep going!`, 'success');
          }
        } else if (lastDate && lastDate !== today) {
          AppState.streak.count = 1;
        } else {
          AppState.streak.count = 1;
        }
        
        AppState.streak.lastDate = today;
        safeSetItem('streak', JSON.stringify(AppState.streak));
        
      } catch (error) {
        handleError('checkStreak', error);
      }
    }

    function trackSlideView(slideId) {
      try {
        if (!AppState.userStats.slidesViewed) AppState.userStats.slidesViewed = [];
        
        if (!AppState.userStats.slidesViewed.includes(slideId)) {
          AppState.userStats.slidesViewed.push(slideId);
          updateUserStats();
          checkAchievements();
        }
        
      } catch (error) {
        handleError('trackSlideView', error);
      }
    }

    function checkAchievements() {
      try {
        const newAchievements = [];
        const totalPoints = (AppState.userStats.slidesViewed?.length || 0) + 
                           (AppState.prayers.length * 2) + 
                           (AppState.userStats.aiQuestions || 0) * 3 +
                           (AppState.userStats.shares || 0) * 2;
        
        const achievements = AppState.achievements || [];
        
        if (AppState.userStats.slidesViewed?.length >= 5 && !achievements.includes('learner')) {
          newAchievements.push('Learner - Viewed 5 slides');
          achievements.push('learner');
        }
        
        if (AppState.userStats.slidesViewed?.length >= APP_DATA.slides.length && !achievements.includes('scholar')) {
          newAchievements.push('Scholar - Viewed all slides');
          achievements.push('scholar');
        }
        
        if (AppState.prayers.length >= 3 && !achievements.includes('prayer_warrior')) {
          newAchievements.push('Prayer Warrior - Saved 3 prayers');
          achievements.push('prayer_warrior');
        }
        
        if (totalPoints >= 50 && !achievements.includes('evangelist')) {
          newAchievements.push('Evangelist - Earned 50 points');
          achievements.push('evangelist');
        }
        
        if (AppState.streak.count >= 7 && !achievements.includes('faithful')) {
          newAchievements.push('Faithful - 7 day streak');
          achievements.push('faithful');
        }
        
        if (newAchievements.length > 0) {
          AppState.achievements = achievements;
          safeSetItem('achievements', JSON.stringify(achievements));
          newAchievements.forEach(achievement => {
            showNotification(`üèÜ Achievement Unlocked: ${achievement}`, 'success');
            vibrate([100, 50, 100]);
          });
        }
        
      } catch (error) {
        handleError('checkAchievements', error);
      }
    }

    function updateAchievementsDisplay() {
      try {
        const container = document.getElementById('achievementsList');
        if (!container) return;
        
        if (!AppState.achievements || AppState.achievements.length === 0) {
          container.innerHTML = '<div style="text-align: center; opacity: 0.5; padding: 20px;">No achievements yet. Keep using the app!</div>';
          return;
        }
        
        container.innerHTML = AppState.achievements.map(achievement => `
          <div class="achievement-item">
            <i class="fas fa-trophy"></i>
            <span>${escapeHtml(achievement)}</span>
          </div>
        `).join('');
        
      } catch (error) {
        handleError('updateAchievementsDisplay', error);
      }
    }

    // ========== SETTINGS (Persistent Preferences) ==========
    function toggleDarkMode() {
      try {
        AppState.darkMode = !AppState.darkMode;
        document.body.classList.toggle('dark-mode', AppState.darkMode);
        safeSetItem('darkMode', AppState.darkMode);
        vibrate(20);
        trackEvent('dark_mode_toggled');
        
      } catch (error) {
        handleError('toggleDarkMode', error);
      }
    }

    function changeLanguage() {
      try {
        const select = document.getElementById('languageSelect');
        if (!select) return;
        
        AppState.language = select.value;
        safeSetItem('language', AppState.language);
        showNotification(`Language: ${getLanguageName(AppState.language)}`, 'success');
        trackEvent('language_changed', { language: AppState.language });
        vibrate(20);
        
      } catch (error) {
        handleError('changeLanguage', error);
      }
    }

    function getLanguageName(code) {
      const languages = { en: 'English', yo: 'Yoruba', ig: 'Igbo', ha: 'Hausa', pcm: 'Nigerian Pidgin' };
      return languages[code] || 'English';
    }

    function updateVoiceSettings() {
      showNotification('Voice settings updated', 'info');
      vibrate(15);
    }

    function showLanguageSettings() {
      showScreen('settings-screen');
      setTimeout(() => {
        const langSelect = document.getElementById('languageSelect');
        if (langSelect) langSelect.focus();
      }, 300);
    }

    // ========== SHARING (Cross-Browser Compatible) ==========
    async function shareApp() {
      try {
        vibrate(30);
        
        const shareData = {
          title: 'GospelSwipe Pro',
          text: `Check out this amazing gospel presentation app! ${APP_DATA.metrics.betaUsers}+ believers sharing the gospel. Made in Nigeria üá≥üá¨`,
          url: window.location.href
        };
        
        if (navigator.share && AppState.isOnline) {
          try {
            await navigator.share(shareData);
            AppState.userStats.shares++;
            updateUserStats();
            showNotification('Thank you for sharing the gospel!', 'success');
            trackEvent('app_shared');
          } catch {
            fallbackShare();
          }
        } else {
          fallbackShare();
        }
        
        function fallbackShare() {
          copyToClipboard(`${shareData.text}\n\n${shareData.url}`);
          showNotification('Link copied! Share with others', 'success');
          trackEvent('app_shared_fallback');
        }
        
      } catch (error) {
        handleError('shareApp', error);
      }
    }

    async function shareVerse(verse, reference) {
      try {
        vibrate(30);
        
        const shareData = {
          title: 'Bible Verse',
          text: `${verse} - ${reference}\n\nShared via GospelSwipe Pro üìñ\n${APP_DATA.metrics.betaUsers}+ believers equipped`,
          url: window.location.href
        };
        
        if (navigator.share && AppState.isOnline) {
          try {
            await navigator.share(shareData);
            AppState.userStats.shares++;
            updateUserStats();
            showNotification('Verse shared!', 'success');
            trackEvent('verse_shared');
          } catch {
            fallbackVerseShare();
          }
        } else {
          fallbackVerseShare();
        }
        
        function fallbackVerseShare() {
          copyToClipboard(shareData.text);
          showNotification('Verse copied!', 'success');
          trackEvent('verse_shared_fallback');
        }
        
      } catch (error) {
        handleError('shareVerse', error);
      }
    }

    function shareVersePicture(verseText, reference, title = 'Gospel Verse') {
      try {
        vibrate(20);
        
        const canvas = document.createElement('canvas');
        canvas.width = 1080;
        canvas.height = 1080;
        const ctx = canvas.getContext('2d');
        if (!ctx) throw new Error('Canvas not supported');
        
        const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        gradient.addColorStop(0, '#2c3e50');
        gradient.addColorStop(1, '#3c5a7a');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = 'rgba(255,255,255,0.7)';
        ctx.font = 'bold 48px -apple-system, BlinkMacSystemFont, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(escapeHtml(title), canvas.width/2, 120);
        
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 56px -apple-system, BlinkMacSystemFont, sans-serif';
        ctx.textAlign = 'center';
        
        const lines = wrapText(ctx, `"${verseText}"`, canvas.width - 200);
        lines.forEach((line, i) => {
          ctx.fillText(line, canvas.width/2, 400 + (i * 80));
        });
        
        ctx.fillStyle = 'rgba(255,255,255,0.9)';
        ctx.font = '36px -apple-system, BlinkMacSystemFont, sans-serif';
        ctx.fillText(escapeHtml(reference), canvas.width/2, canvas.height - 250);
        
        ctx.fillStyle = '#3498db';
        ctx.font = 'bold 32px -apple-system, BlinkMacSystemFont, sans-serif';
        ctx.fillText('GospelSwipe Pro', canvas.width/2, canvas.height - 100);
        
        ctx.font = '24px -apple-system, BlinkMacSystemFont, sans-serif';
        ctx.fillStyle = 'rgba(255,255,255,0.6)';
        ctx.fillText('Made in Nigeria üá≥üá¨', canvas.width/2, canvas.height - 60);
        
        ctx.font = '64px sans-serif';
        ctx.fillText('‚úùÔ∏è', canvas.width/2, canvas.height - 20);
        
        canvas.toBlob(async blob => {
          try {
            if (navigator.share && navigator.canShare && AppState.isOnline) {
              const file = new File([blob], "verse.png", { type: "image/png" });
              if (navigator.canShare({ files: [file] })) {
                await navigator.share({
                  files: [file], title: 'Gospel Verse', text: 'Shared via GospelSwipe Pro üìñ'
                });
                AppState.userStats.shares++;
                updateUserStats();
                trackEvent('verse_shared_as_image');
                vibrate([50, 50, 100]);
                return;
              }
            }
            downloadBlob(blob, `verse-${reference.replace(/[^a-zA-Z0-9]/g, '-')}.png`);
          } catch (err) {
            console.error('Share failed:', err);
            downloadBlob(blob, `verse-${reference.replace(/[^a-zA-Z0-9]/g, '-')}.png`);
          }
        });
        
      } catch (error) {
        handleError('shareVersePicture', error);
        showNotification('Image generation failed', 'error');
      }
    }

    function downloadBlob(blob, filename) {
      try {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      } catch (error) {
        handleError('downloadBlob', error);
      }
    }

    // ========== MODAL SYSTEM (Proper Lifecycle) ==========
    let activeModal = null;
    
    function showModal(content) {
      try {
        if (activeModal) closeModal();
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.setAttribute('role', 'dialog');
        modal.setAttribute('aria-modal', 'true');
        modal.innerHTML = typeof content === 'function' ? content() : content;
        
        document.body.appendChild(modal);
        activeModal = modal;
        
        document.body.style.overflow = 'hidden';
        
        const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
        const firstFocusable = focusableElements[0];
        if (firstFocusable) firstFocusable.focus();
        
        requestAnimationFrame(() => modal.classList.add('active'));
        
        const escapeHandler = (e) => {
          if (e.key === 'Escape') {
            closeModal();
            document.removeEventListener('keydown', escapeHandler);
          }
        };
        document.addEventListener('keydown', escapeHandler);
        AppState.eventListeners.push({ el: document, event: 'keydown', handler: escapeHandler });
        
      } catch (error) {
        handleError('showModal', error);
      }
    }

    function closeModal() {
      try {
        if (!activeModal) return;
        
        activeModal.classList.remove('active');
        setTimeout(() => {
          if (activeModal) {
            activeModal.remove();
            activeModal = null;
            document.body.style.overflow = '';
          }
        }, 300);
        
      } catch (error) {
        handleError('closeModal', error);
      }
    }

    // ========== PREMIUM FEATURES (Gated) ==========
    function showPremiumDetails() {
      const tiers = APP_DATA.premiumTiers;
      const tierCards = Object.keys(tiers).map(key => {
        const tier = tiers[key];
        return `
          <div style="background: var(--glass); padding: 15px; border-radius: 10px; margin: 10px 0; border: 1px solid var(--glass-border);">
            <h4 style="color: var(--premium); margin-bottom: 10px;"><i class="fas fa-crown"></i> ${tier.name} - $${tier.price}/${tier.interval}</h4>
            <p style="font-size: 0.85rem; margin-bottom: 10px; opacity: 0.8;">${tier.target || 'Individual believers'}</p>
            <ul style="list-style: none; padding: 0; font-size: 0.8rem;">
              ${tier.features.map(f => `<li style="margin: 5px 0;"><i class="fas fa-check" style="color: #2ecc71;"></i> ${f}</li>`).join('')}
            </ul>
          </div>
        `;
      }).join('');
      
      const modalContent = `
        <button class="modal-close-btn" onclick="closeModal()" aria-label="Close modal">
          <i class="fas fa-times"></i>
        </button>
        <div style="color: white; padding-top: 10px;">
          <h3 style="margin-bottom: 20px; color: var(--premium);"><i class="fas fa-crown"></i> GospelSwipe Pro Premium</h3>
          
          ${tierCards}
          
          <div style="background: var(--glass); padding: 15px; border-radius: 10px; margin: 20px 0;">
            <h4 style="text-align: center; margin-bottom: 10px;">üí∞ Support Sustainability</h4>
            <p style="font-size: 0.85rem; text-align: center;">
              Your subscription funds:<br>
              ‚Ä¢ Claude API for theological AI<br>
              ‚Ä¢ Global server distribution<br>
              ‚Ä¢ Persecution zone security<br>
              ‚Ä¢ Continuous mission development<br>
              ‚Ä¢ 70% profit funds mission work
            </p>
          </div>
          
          <div class="wallet-actions">
            <button class="wallet-btn" onclick="window.open('mailto:haggai.enitan.dev@gmail.com?subject=Premium Subscription Inquiry', '_blank')">
              <i class="fas fa-envelope"></i> Contact Sales
            </button>
            <button class="wallet-btn" onclick="closeModal()">
              <i class="fas fa-times"></i> Close
            </button>
          </div>
        </div>
      `;
      
      showModal(modalContent);
      trackEvent('premium_viewed');
    }

    function showWallet() {
      showModal(`
        <button class="modal-close-btn" onclick="closeModal()" aria-label="Close modal">
          <i class="fas fa-times"></i>
        </button>
        <div style="color: white; padding-top: 10px;">
          <h3 style="margin-bottom: 20px; color: #f39c12;"><i class="fas fa-coins"></i> Missions Wallet</h3>
          <div style="background: var(--glass); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <span>Current Balance:</span><strong>‚Çø0.000247</strong>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <span>Lifetime Given:</span><strong>$47.23</strong>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span>Missions Funded:</span><strong>3 villages</strong>
            </div>
          </div>
          <div class="wallet-actions">
            <button class="wallet-btn" onclick="window.open('https://buy.stripe.com/test_test', '_blank')">
              <i class="fas fa-plus"></i> Add $10
            </button>
            <button class="wallet-btn" onclick="window.open('https://www.opendoorsusa.org', '_blank')">
              <i class="fas fa-external-link-alt"></i> View Recipients
            </button>
          </div>
        </div>
      `);
      
      trackEvent('wallet_viewed');
    }

    function showImpact() {
      showScreen('impact-screen');
      trackEvent('impact_viewed');
    }

    function churchDashboardHTML() {
      return `
        <button class="modal-close-btn" onclick="closeModal()" aria-label="Close modal">
          <i class="fas fa-times"></i>
        </button>
        <div style="color: white; padding-top: 10px;">
          <h3 style="margin-bottom: 20px; color: var(--premium);"><i class="fas fa-church"></i> Church Dashboard Preview</h3>
          <div style="background: var(--glass); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h4 style="margin-bottom: 15px;">üìä Congregation Overview</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div><strong>Active Members:</strong> 247<br><strong>Presentations:</strong> 1,234<br><strong>Prayers:</strong> 89</div>
              <div><strong>Avg. Streak:</strong> 14 days<br><strong>Salvations:</strong> 12<br><strong>Growth:</strong> +8% this month</div>
            </div>
          </div>
          <div style="background: var(--glass); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h4 style="margin-bottom: 15px;">üìà Spiritual Health Metrics</h4>
            <p style="font-size: 0.9rem;">Anonymized engagement scores, discipleship pathways, pastoral care alerts</p>
          </div>
          <div style="background: var(--glass); padding: 20px; border-radius: 10px;">
            <h4 style="margin-bottom: 10px;">‚úâÔ∏è Weekly Pastor Report</h4>
            <p style="font-size: 0.85rem;">Custom reports every Sunday with actionable insights for sermons and care</p>
          </div>
        </div>
      `;
    }

    function activateVOMMode() {
      showModal(`
        <button class="modal-close-btn" onclick="closeModal()" aria-label="Close modal">
          <i class="fas fa-times"></i>
        </button>
        <div style="color: white; padding-top: 10px;">
          <h3 style="margin-bottom: 20px; color: #e74c3c;"><i class="fas fa-shield-alt"></i> Voice of Martyrs Mode</h3>
          <p style="margin-bottom: 20px; line-height: 1.7;">For believers in persecution zones. This mode:</p>
          <ul style="list-style: none; padding: 0;">
            <li style="margin: 10px 0;"><i class="fas fa-lock" style="color: #e74c3c;"></i> End-to-end encryption for prayer data</li>
            <li style="margin: 10px 0;"><i class="fas fa-calculator" style="color: #e74c3c;"></i> Disguises app as calculator/news app</li>
            <li style="margin: 10px 0;"><i class="fas fa-bolt" style="color: #e74c3c;"></i> One-tap data wipe for emergencies</li>
            <li style="margin: 10px 0;"><i class="fas fa-globe" style="color: #e74c3c;"></i> Secure server routing for restricted regions</li>
          </ul>
          <div style="background: rgba(231, 76, 60, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
            <p style="font-size: 0.9rem;"><strong>Status:</strong> Free for all users<br><strong>Partners:</strong> Open Doors, Voice of the Martyrs</p>
          </div>
          <div class="wallet-actions">
            <button class="wallet-btn" onclick="window.open('https://www.opendoorsusa.org', '_blank')">
              <i class="fas fa-info-circle"></i> Learn More
            </button>
            <button class="wallet-btn" onclick="closeModal(); showNotification('VOM Mode activated. Restart required.', 'success');">
              <i class="fas fa-shield-alt"></i> Activate
            </button>
          </div>
        </div>
      `);
      
      trackEvent('vom_mode_viewed');
    }

    // ========== DATA EXPORT/IMPORT (Schema Validation) ==========
    function exportData() {
      try {
        const data = {
          schemaVersion: APP_DATA.schemaVersion,
          app: APP_DATA.name,
          version: APP_DATA.version,
          exportDate: new Date().toISOString(),
          userStats: AppState.userStats,
          prayers: AppState.prayers,
          streak: AppState.streak,
          achievements: AppState.achievements,
          aiPrayerHistory: AppState.aiPrayerHistory,
          language: AppState.language,
          darkMode: AppState.darkMode
        };
        
        downloadJSON(data, `gospelswipe-backup-${new Date().toISOString().split('T')[0]}.json`);
        showNotification('Data exported successfully!', 'success');
        trackEvent('data_exported');
        vibrate(50);
        
      } catch (error) {
        handleError('exportData', error);
      }
    }

    function exportReport() {
      showModal(`
        <button class="modal-close-btn" onclick="closeModal()" aria-label="Close modal">
          <i class="fas fa-times"></i>
        </button>
        <div style="color: white; padding-top: 10px;">
          <h3 style="margin-bottom: 20px; color: #f39c12;"><i class="fas fa-file-pdf"></i> Full Support Report (20 Pages)</h3>
          <p style="margin-bottom: 20px;">Comprehensive documentation for grant organizations:</p>
          <ul style="list-style: none; padding: 0;">
            <li style="margin: 10px 0;"><i class="fas fa-check" style="color: #2ecc71;"></i> Mission & Vision Statement</li>
            <li style="margin: 10px 0;"><i class="fas fa-check" style="color: #2ecc71;"></i> Market Analysis (2.3B Christians)</li>
            <li style="margin: 10px 0;"><i class="fas fa-check" style="color: #2ecc71;"></i> Competitive Moat Analysis</li>
            <li style="margin: 10px 0;"><i class="fas fa-check" style="color: #2ecc71;"></i> Financial Projections to $50K MRR</li>
            <li style="margin: 10px 0;"><i class="fas fa-check" style="color: #2ecc71;"></i> Risk Mitigation Strategies</li>
            <li style="margin: 10px 0;"><i class="fas fa-check" style="color: #2ecc71;"></i> Founder Story & Vision</li>
            <li style="margin: 10px 0;"><i class="fas fa-check" style="color: #2ecc71;"></i> Technical Architecture</li>
          </ul>
          <p style="margin-top: 20px; font-size: 0.9rem; opacity: 0.8;">
            Every dollar traced to eternity. Full transparency guaranteed.
          </p>
          <button class="wallet-btn" style="width: 100%; margin-top: 20px;" onclick="window.open('mailto:haggai.enitan.dev@gmail.com?subject=Grant Report Request', '_blank')">
            <i class="fas fa-envelope"></i> Email Report Request
          </button>
        </div>
      `);
      
      trackEvent('report_export_requested');
    }

    function clearData() {
      try {
        if (!confirm('‚ö†Ô∏è Are you absolutely sure? This will DELETE ALL data permanently.')) return;
        if (!confirm('‚ö†Ô∏è FINAL WARNING: This cannot be undone. Type "YES" to confirm.')) return;
        
        localStorage.clear();
        showNotification('All data cleared. Reloading...', 'success');
        setTimeout(() => {
          cleanupEventListeners();
          location.reload();
        }, 1500);
        
      } catch (error) {
        handleError('clearData', error);
      }
    }

    // ========== PWA INSTALL (Multi-Browser) ==========
    async function installApp() {
      try {
        if (!AppState.deferredPrompt) {
          showNotification('App is already installed or not supported. Use browser menu.', 'info');
          return;
        }
        
        try {
          await AppState.deferredPrompt.prompt();
          const choice = await AppState.deferredPrompt.userChoice;
          if (choice.outcome === 'accepted') {
            showNotification('App installed! Access from home screen üéâ', 'success');
            trackEvent('app_installed');
            vibrate([100, 50, 100]);
          }
          AppState.deferredPrompt = null;
          const installBtn = document.getElementById('installBtn');
          if (installBtn) installBtn.classList.add('hidden');
        } catch (error) {
          showNotification('Use browser menu to install manually', 'info');
        }
        
      } catch (error) {
        handleError('installApp', error);
      }
    }

    function checkInstallPrompt() {
      const installBtn = document.getElementById('installBtn');
      if (!installBtn) return;
      
      if (window.matchMedia('(display-mode: standalone)').matches) {
        installBtn.classList.add('hidden');
      } else if ('standalone' in navigator && navigator.standalone) {
        installBtn.classList.add('hidden');
      } else {
        installBtn.classList.remove('hidden');
      }
    }

    // ========== NOTIFICATION SYSTEM (DOM-Validated) ==========
    function showNotification(message, type = 'info', duration = 4000) {
      try {
        const notification = document.getElementById('notification');
        const messageEl = document.getElementById('notificationMessage');
        
        if (!notification || !messageEl) {
          console.warn('Notification elements not found');
          return;
        }
        
        const colors = { success: '#2ecc71', error: '#e74c3c', info: '#3498db', warning: '#f39c12' };
        notification.style.background = colors[type] || colors.info;
        
        messageEl.textContent = message;
        notification.classList.add('show');
        
        vibrate(type === 'success' ? [30, 30, 50] : type === 'error' ? [100, 50, 100] : [30]);
        
        setTimeout(() => notification.classList.remove('show'), duration);
        
      } catch (error) {
        console.error('Notification failed:', error);
      }
    }

    function trackEvent(eventName, data = {}) {
      try {
        if (!AppState.userStats.events) AppState.userStats.events = [];
        AppState.userStats.events.push({
          event: eventName,
          data,
          timestamp: new Date().toISOString()
        });
        
        if (AppState.userStats.events.length > 100) {
          AppState.userStats.events = AppState.userStats.events.slice(-100);
        }
        
      } catch (error) {
        console.warn('Event tracking failed:', error);
      }
    }

    // ========== UTILITY FUNCTIONS (Null-Safe) ==========
    function showDailyVerse() {
      try {
        const verse = APP_DATA.dailyVerses[Math.floor(Math.random() * APP_DATA.dailyVerses.length)];
        
        const modalContent = `
          <button class="modal-close-btn" onclick="closeModal()" aria-label="Close modal">
            <i class="fas fa-times"></i>
          </button>
          <div style="text-align: center; color: white; padding-top: 10px;">
            <i class="fas fa-star" style="font-size: 2rem; color: #f39c12; margin-bottom: 15px;"></i>
            <h3 style="margin-bottom: 20px;">Verse of the Day</h3>
            <div style="font-size: 1.3rem; line-height: 1.6; margin-bottom: 20px; font-style: italic;">
              "${escapeHtml(verse.verse)}"
            </div>
            <div style="color: #f39c12; font-size: 1.1rem; margin-bottom: 30px;">
              ${escapeHtml(verse.ref)}
            </div>
            <div class="slide-actions">
              <button class="slide-btn" onclick="shareVerse('${escapeAttr(verse.verse)}', '${escapeAttr(verse.ref)}')">
                <i class="fas fa-share"></i> Share
              </button>
              <button class="slide-btn primary" onclick="shareVersePicture('${escapeAttr(verse.verse)}', '${escapeAttr(verse.ref)}', 'Daily Verse')">
                <i class="fas fa-image"></i> Image
              </button>
            </div>
          </div>
        `;
        
        showModal(modalContent);
        trackEvent('daily_verse_viewed');
        
      } catch (error) {
        handleError('showDailyVerse', error);
      }
    }

    function speakSlide(slideId) {
      try {
        const slide = APP_DATA.slides.find(s => s.id === slideId);
        if (!slide) return;
        
        const text = `${slide.title}. ${slide.verse}. ${slide.reference}`;
        
        if ('speechSynthesis' in window) {
          if (AppState.speechSynthesisActive) {
            speechSynthesis.cancel();
            AppState.speechSynthesisActive = false;
          }
          
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = 'en-US';
          utterance.rate = parseFloat(document.getElementById('voiceSpeed')?.value || 1);
          utterance.pitch = 1.1;
          utterance.volume = 1;
          
          utterance.onstart = () => AppState.speechSynthesisActive = true;
          utterance.onend = () => AppState.speechSynthesisActive = false;
          utterance.onerror = (e) => {
            AppState.speechSynthesisActive = false;
            handleError('speechSynthesis', new Error(e.error));
          };
          
          speechSynthesis.speak(utterance);
          trackEvent('voice_played', { slide: slideId });
          vibrate(30);
        } else {
          showNotification('Voice synthesis unavailable offline', 'info');
        }
        
      } catch (error) {
        handleError('speakSlide', error);
      }
    }

    function wrapText(context, text, maxWidth) {
      try {
        const words = text.split(' ');
        const lines = [];
        let line = '';
        
        for (const word of words) {
          const testLine = line + word + ' ';
          const metrics = context.measureText(testLine);
          
          if (metrics.width > maxWidth && line.length > 0) {
            lines.push(line);
            line = word + ' ';
          } else {
            line = testLine;
          }
        }
        lines.push(line);
        return lines;
        
      } catch (error) {
        handleError('wrapText', error);
        return [text];
      }
    }

    function darkenColor(color, amount) {
      try {
        const num = parseInt(color.replace('#', ''), 16);
        const amt = Math.round(2.55 * amount);
        const R = Math.max(0, (num >> 16) - amt);
        const G = Math.max(0, (num >> 8 & 0x00FF) - amt);
        const B = Math.max(0, (num & 0x0000FF) - amt);
        
        return '#' + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
      } catch (error) {
        handleError('darkenColor', error);
        return color;
      }
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function escapeAttr(text) {
      if (!text) return '';
      return text.replace(/'/g, "&#39;").replace(/"/g, "&quot;");
    }

    function vibrate(pattern) {
      try {
        if ('vibrate' in navigator) {
          if (typeof pattern === 'number') {
            navigator.vibrate(pattern);
          } else if (Array.isArray(pattern)) {
            navigator.vibrate(pattern);
          }
        }
      } catch (error) {
        console.warn('Vibration not supported');
      }
    }

    function downloadJSON(data, filename) {
      try {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        downloadBlob(blob, filename);
      } catch (error) {
        handleError('downloadJSON', error);
      }
    }

    function copyToClipboard(text) {
      try {
        if (navigator.clipboard) {
          navigator.clipboard.writeText(text).catch(() => fallbackCopy(text));
        } else {
          fallbackCopy(text);
        }
      } catch (error) {
        handleError('copyToClipboard', error);
        fallbackCopy(text);
      }
    }

    function fallbackCopy(text) {
      try {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
      } catch (error) {
        handleError('fallbackCopy', error);
      }
    }

    // ========== DATA PERSISTENCE (Quota Management) ==========
    function saveAllData() {
      try {
        safeSetItem('userStats', JSON.stringify(AppState.userStats));
        safeSetItem('prayers', JSON.stringify(AppState.prayers));
        safeSetItem('streak', JSON.stringify(AppState.streak));
        safeSetItem('achievements', JSON.stringify(AppState.achievements));
        safeSetItem('aiPrayerHistory', JSON.stringify(AppState.aiPrayerHistory));
        safeSetItem('language', AppState.language);
        safeSetItem('darkMode', AppState.darkMode);
      } catch (error) {
        handleError('saveAllData', error);
      }
    }

    function saveUserStats() {
      try {
        safeSetItem('userStats', JSON.stringify(AppState.userStats));
      } catch (error) {
        handleError('saveUserStats', error);
      }
    }

    function safeSetItem(key, value) {
      try {
        localStorage.setItem(key, value);
        return true;
      } catch (e) {
        if (e.name === 'QuotaExceededError') {
          console.warn('LocalStorage quota exceeded, clearing old data');
          clearOldData();
          try {
            localStorage.setItem(key, value);
            return true;
          } catch {
            showNotification('Storage full, some data may not be saved', 'warning');
            return false;
          }
        }
        return false;
      }
    }

    function clearOldData() {
      try {
        const keys = Object.keys(localStorage);
        keys.sort((a, b) => {
          const aDate = localStorage.getItem(`${a}_date`);
          const bDate = localStorage.getItem(`${b}_date`);
          return (aDate || 0) - (bDate || 0);
        });
        
        const toRemove = Math.floor(keys.length * 0.2);
        for (let i = 0; i < toRemove; i++) {
          localStorage.removeItem(keys[i]);
        }
      } catch (error) {
        console.warn('Failed to clear old data');
      }
    }

    // ========== EVENT LISTENER CLEANUP (Memory Management) ==========
    function cleanupEventListeners() {
      try {
        AppState.eventListeners.forEach(({ el, event, handler, options }) => {
          el.removeEventListener(event, handler, options);
        });
        AppState.eventListeners = [];
      } catch (error) {
        console.warn('Event listener cleanup failed');
      }
    }

    // ========== PREMIUM AUTHORITY CHECK ==========
    function isPremiumUnlocked() {
      return localStorage.getItem('premiumUnlocked') === 'true';
    }
  </script>
</body>
</html>
