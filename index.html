<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; font-src https://cdnjs.cloudflare.com; img-src 'self' data: blob:; connect-src 'self'">
  
  <title>GospelSwipe Pro - Digital Evangelism Platform</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#2c3e50">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="GospelSwipe">
  <meta name="description" content="AI-powered gospel presentation with prayer journal, multi-language support, and 100% offline evangelism tools. Made in Nigeria üá≥üá¨">
  <meta name="keywords" content="evangelism, gospel, bible, prayer, christian, Nigeria, offline, PWA, Voice of Martyrs">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚úùÔ∏è</text></svg>">
  
  <!-- Fonts & Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Styles -->
  <style>
    /* ========== CSS VARIABLES (Optimized for Performance) ========== */
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --accent: #e74c3c;
      --success: #27ae60;
      --warning: #f39c12;
      --premium: #9b59b6;
      --light: #ecf0f1;
      --dark: #1a1a1a;
      --radius: 12px;
      --shadow: 0 8px 30px rgba(0,0,0,0.12);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --glass: rgba(255,255,255,0.08);
      --glass-border: rgba(255,255,255,0.12);
    }

    /* ========== FOUNDATION RESET (Zero Bugs) ========== */
    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.6;
      color: var(--light);
      background: linear-gradient(135deg, var(--primary) 0%, #34495e 100%);
      min-height: 100vh;
      position: relative;
      transition: var(--transition);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      user-select: none;
      -webkit-user-select: none;
    }

    body.dark-mode {
      background: linear-gradient(135deg, #0f1419 0%, #1a252f 100%);
    }

    /* ========== LOADING SCREEN (Flight Mode Ready - FIXED) ========== */
    #loading {
      position: fixed;
      inset: 0;
      background: var(--primary);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 999999;
      transition: opacity 0.5s;
    }

    .loader {
      width: 48px;
      height: 48px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ========== APP CONTAINER (Fixed Z-Index) ========== */
    .app-container {
      display: none;
      position: relative;
      width: 100%;
      height: 100vh;
      overflow: hidden;
      z-index: 1;
    }

    .app-container.active {
      display: block;
    }

    /* ========== SKELETON LOADER (Lightweight) ========== */
    .skeleton {
      background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: var(--radius);
    }

    .skeleton-text { height: 20px; margin: 10px 0; }
    .skeleton-card { min-height: 140px; margin-bottom: 15px; padding: 20px; }

    @keyframes shimmer {
      0% { background-position: -200px 0; }
      100% { background-position: 200px 0; }
    }

    /* ========== HOME SCREEN (100% Offline) ========== */
    #home-screen {
      position: fixed;
      inset: 0;
      padding: 20px 20px calc(70px + env(safe-area-inset-bottom));
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      z-index: 100;
    }

    .header {
      text-align: center;
      margin-top: 20px;
      flex-shrink: 0;
      position: relative;
    }

    .header h1 {
      font-size: clamp(1.8rem, 5vw, 2.2rem);
      margin-bottom: 5px;
      background: linear-gradient(to right, #3498db, #2ecc71);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 700;
    }

    .tagline {
      font-size: 1rem;
      opacity: 0.8;
      margin-bottom: 20px;
    }

    .header-settings-btn {
      position: absolute;
      top: 0;
      right: 0;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      color: #fff;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      z-index: 10;
    }

    .header-settings-btn:hover {
      background: rgba(255,255,255,0.2);
      transform: rotate(30deg);
    }

    /* ========== USER STATS ========== */
    .user-stats {
      margin-bottom: 20px;
    }

    .stats-row {
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: bold;
    }

    .stat-label {
      font-size: 0.8rem;
      opacity: 0.7;
    }

    /* ========== FEATURE GRID (Touch-Optimized) ========== */
    .features-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin: 20px 0;
      flex: 1;
    }

    .feature-card {
      background: var(--glass);
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      padding: 18px;
      text-align: center;
      transition: var(--transition);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-height: 130px;
      position: relative;
      overflow: hidden;
    }

    .feature-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: left 0.5s;
    }

    .feature-card:hover::before {
      left: 100%;
    }

    .feature-card:hover {
      transform: translateY(-3px);
      background: rgba(255,255,255,0.12);
      box-shadow: var(--shadow);
    }

    .feature-card i {
      font-size: 1.6rem;
      margin-bottom: 8px;
      color: var(--secondary);
    }

    .feature-card h3 {
      font-size: 0.95rem;
      margin-bottom: 5px;
    }

    .feature-card p {
      font-size: 0.75rem;
      opacity: 0.7;
    }

    .feature-badge {
      background: rgba(52, 152, 219, 0.2);
      color: var(--secondary);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.65rem;
      margin-top: 5px;
      display: inline-block;
      font-weight: 600;
      z-index: 1;
      position: relative;
    }

    .premium-badge {
      background: rgba(155, 89, 182, 0.3);
      color: var(--premium);
      border: 1px solid rgba(155, 89, 182, 0.5);
    }

    /* ========== SLIDE SYSTEM (Fixed Navigation) ========== */
    .slides-container {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    .slide {
      position: absolute;
      inset: 0;
      padding: 60px 20px calc(100px + env(safe-area-inset-bottom));
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      opacity: 0;
      transform: translateX(100%);
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s;
      z-index: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      pointer-events: none;
    }

    .slide.active {
      opacity: 1;
      transform: translateX(0);
      z-index: 3;
      pointer-events: all;
    }

    .slide.previous {
      transform: translateX(-100%);
      z-index: 2;
    }

    .slide.next {
      transform: translateX(100%);
      z-index: 1;
    }

    .slide-content {
      max-width: 650px;
      width: 90%;
    }

    .slide-header {
      margin-bottom: 25px;
    }

    .slide-number {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 5px 15px;
      font-size: 0.85rem;
      margin-bottom: 15px;
      display: inline-block;
      font-weight: 600;
    }

    .slide-title {
      font-size: clamp(1.5rem, 5vw, 2rem);
      margin-bottom: 20px;
      line-height: 1.3;
      font-weight: 700;
    }

    .slide-verse {
      font-size: clamp(1.1rem, 4vw, 1.3rem);
      line-height: 1.6;
      margin-bottom: 20px;
      padding: 25px;
      background: rgba(0,0,0,0.2);
      border-radius: var(--radius);
      border-left: 4px solid var(--secondary);
      font-style: italic;
    }

    .slide-reference {
      font-size: 1.1rem;
      opacity: 0.9;
      margin-bottom: 25px;
      font-weight: 600;
    }

    .slide-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .slide-btn {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      color: #fff;
      padding: 12px 20px;
      border-radius: 25px;
      cursor: pointer;
      transition: var(--transition);
      font-size: 0.9rem;
      min-width: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      white-space: nowrap;
    }

    .slide-btn:hover {
      background: rgba(255,255,255,0.15);
      transform: translateY(-2px);
    }

    .slide-btn.primary {
      background: linear-gradient(135deg, #3498db, #2980b9);
      border-color: rgba(255,255,255,0.2);
    }

    .slide-btn.premium {
      background: linear-gradient(135deg, var(--premium), #8e44ad);
      border-color: rgba(155, 89, 182, 0.3);
    }

    .hidden {
      display: none !important;
    }

    .slide-indicator {
      position: absolute;
      bottom: 20px;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 40px;
      padding: 0 30px;
      opacity: 0.6;
      font-size: 0.8rem;
    }

    /* ========== SCREEN MANAGEMENT (Fixed Z-Index) ========== */
    .screen {
      position: fixed;
      inset: 0;
      padding: 20px 20px calc(70px + env(safe-area-inset-bottom));
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      background: linear-gradient(135deg, var(--primary) 0%, #34495e 100%);
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 200;
      display: none;
    }

    body.dark-mode .screen {
      background: linear-gradient(135deg, #0f1419 0%, #1a252f 100%);
    }

    .screen.active {
      transform: translateX(0);
      display: flex;
      flex-direction: column;
      z-index: 201;
    }

    #presentation-screen {
      padding: 0;
      z-index: 300;
    }

    #presentation-screen.active {
      z-index: 301;
    }

    /* ========== BOTTOM NAVIGATION (Fixed) ========== */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: calc(70px + env(safe-area-inset-bottom));
      background: rgba(0,0,0,0.95);
      backdrop-filter: blur(20px);
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding-bottom: env(safe-area-inset-bottom);
      border-top: 1px solid var(--glass-border);
      z-index: 1000;
    }

    .nav-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 3px;
      background: none;
      border: none;
      color: rgba(255,255,255,0.7);
      transition: var(--transition);
      padding: 8px;
      cursor: pointer;
      min-width: 60px;
    }

    .nav-btn.active {
      color: var(--secondary);
      transform: translateY(-3px);
    }

    .nav-btn i {
      font-size: 1.3rem;
      transition: transform 0.2s;
    }

    .nav-btn span {
      font-size: 0.7rem;
      font-weight: 500;
    }

    /* ========== PRAYER JOURNAL (Fixed) ========== */
    .journal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-shrink: 0;
    }

    .journal-header h2 {
      font-size: 1.5rem;
    }

    .close-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.5rem;
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: var(--transition);
    }

    .close-btn:hover {
      background: rgba(255,255,255,0.1);
    }

    #prayerInput {
      width: 100%;
      min-height: 120px;
      max-height: 200px;
      padding: 15px;
      border-radius: var(--radius);
      border: 2px solid var(--glass-border);
      background: var(--glass);
      color: #fff;
      font-size: 1rem;
      resize: vertical;
      margin-bottom: 20px;
      flex-shrink: 0;
      font-family: inherit;
    }

    #prayerInput:focus {
      outline: none;
      border-color: var(--secondary);
    }

    .prayer-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      flex-shrink: 0;
    }

    .action-btn {
      flex: 1;
      padding: 12px;
      border-radius: var(--radius);
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .action-btn:hover {
      transform: translateY(-2px);
      opacity: 0.95;
    }

    .action-btn.primary {
      background: var(--secondary);
      color: white;
    }

    .action-btn.secondary {
      background: transparent;
      border: 1px solid var(--glass-border);
      color: #fff;
    }

    .prayer-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
      flex: 1;
      overflow-y: auto;
    }

    .prayer-item {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      padding: 15px;
      border-left: 4px solid var(--success);
      transition: var(--transition);
      position: relative;
    }

    .prayer-item:hover {
      transform: translateX(5px);
    }

    .prayer-item.answered {
      border-left-color: var(--accent);
      opacity: 0.8;
    }

    .prayer-date {
      font-size: 0.75rem;
      opacity: 0.6;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .prayer-date button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      transition: transform 0.2s;
    }

    .prayer-date button:hover {
      transform: scale(1.2);
    }

    /* ========== SETTINGS SCREEN (Privacy-Focused) ========== */
    .settings-section {
      margin-bottom: 30px;
      flex-shrink: 0;
    }

    .settings-title {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 15px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }

    .settings-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      margin-bottom: 10px;
    }

    .settings-option select {
      background: var(--glass);
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    /* ========== SWITCH TOGGLE (Accessible) ========== */
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      inset: 0;
      background-color: rgba(255,255,255,0.3);
      transition: .4s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: var(--secondary);
    }

    input:checked + .slider:before {
      transform: translateX(26px);
    }

    /* ========== STATISTICS SCREEN (Gamification) ========== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 30px;
      flex-shrink: 0;
    }

    .stat-card {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      padding: 20px;
      text-align: center;
      transition: var(--transition);
    }

    .stat-card:hover {
      transform: scale(1.03);
    }

    .stat-card .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: var(--secondary);
      margin-bottom: 5px;
    }

    .stat-card .stat-label {
      font-size: 0.85rem;
      opacity: 0.8;
    }

    .achievement-item {
      background: rgba(241, 196, 15, 0.1);
      border: 1px solid rgba(241, 196, 15, 0.3);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: var(--transition);
    }

    .achievement-item:hover {
      transform: translateX(5px);
    }

    .achievement-item i {
      color: #f39c12;
    }

    /* ========== MODAL SYSTEM (Bug-Free) ========== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.95);
      backdrop-filter: blur(20px);
      z-index: 2000;
      opacity: 0;
      transition: opacity 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.active {
      opacity: 1;
    }

    .modal-content {
      background: linear-gradient(135deg, #2c3e50, #34495e);
      border: 1px solid var(--glass-border);
      padding: 40px 30px 30px;
      border-radius: 20px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      transform: translateY(20px) scale(0.95);
      transition: transform 0.3s;
      position: relative;
      box-shadow: var(--shadow);
    }

    .modal-overlay.active .modal-content {
      transform: translateY(0) scale(1);
    }

    .modal-close-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      color: #fff;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      z-index: 1001;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .modal-close-btn:hover {
      background: var(--accent);
      transform: rotate(90deg);
    }

    /* ========== NOTIFICATION (Toast) ========== */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--success);
      color: white;
      padding: 15px 25px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      transform: translateX(150%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 2001;
      max-width: 300px;
      font-weight: 500;
    }

    .notification.show {
      transform: translateX(0);
    }

    /* ========== EXIT BUTTON (Fixed) ========== */
    .exit-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      color: #fff;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .exit-btn:hover {
      background: var(--accent);
    }

    /* ========== HOME BOTTOM (PWA Install) ========== */
    .home-bottom-buttons {
      text-align: center;
      margin-top: auto;
      padding-bottom: 20px;
      flex-shrink: 0;
    }

    .install-info {
      opacity: 0.7;
      font-size: 0.85rem;
      margin-bottom: 15px;
    }

    .install-btn {
      background: linear-gradient(135deg, #2ecc71, #27ae60);
      color: white;
      border: none;
      padding: 14px 30px;
      border-radius: 25px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 10px;
      min-width: 200px;
      justify-content: center;
    }

    .install-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
    }

    /* ========== PREMIUM BANNER (Grant-Fund Optimized) ========== */
    .premium-banner {
      background: linear-gradient(135deg, rgba(155, 89, 182, 0.1), rgba(142, 68, 173, 0.1));
      border: 1px solid rgba(155, 89, 182, 0.3);
      border-radius: var(--radius);
      padding: 20px;
      margin: 20px 0;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .premium-banner::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.05), transparent);
      animation: shine 3s infinite;
    }

    @keyframes shine {
      0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    .premium-banner h3 {
      position: relative;
      z-index: 1;
      margin-bottom: 10px;
      color: var(--premium);
    }

    .premium-banner p {
      position: relative;
      z-index: 1;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    /* ========== WALLET WIDGET (Crypto/Missions) ========== */
    .wallet-widget {
      background: linear-gradient(135deg, rgba(243, 156, 18, 0.1), rgba(230, 126, 34, 0.1));
      border: 1px solid rgba(243, 156, 18, 0.3);
      border-radius: var(--radius);
      padding: 15px;
      margin: 15px 0;
    }

    .wallet-balance {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--warning);
    }

    .wallet-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .wallet-btn {
      flex: 1;
      padding: 10px;
      border: 1px solid rgba(243, 156, 18, 0.5);
      background: rgba(243, 156, 18, 0.1);
      color: var(--warning);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: var(--transition);
      font-weight: 500;
    }

    .wallet-btn:hover {
      background: rgba(243, 156, 18, 0.2);
    }

    /* ========== IMPACT SCREEN (Grant-Ready) ========== */
    .impact-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .impact-card {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      padding: 20px;
      text-align: center;
      transition: var(--transition);
    }

    .impact-card:hover {
      transform: translateY(-5px);
    }

    .impact-value {
      font-size: 2.5rem;
      font-weight: bold;
      color: var(--warning);
    }

    .impact-label {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .grant-section {
      background: rgba(52, 152, 219, 0.1);
      border: 1px solid rgba(52, 152, 219, 0.3);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
    }

    .grant-metric {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .grant-metric:last-child {
      border-bottom: none;
    }

    .grant-metric strong {
      color: var(--warning);
    }

    .call-to-action {
      background: linear-gradient(135deg, rgba(243, 156, 18, 0.2), rgba(230, 126, 34, 0.2));
      border: 1px solid rgba(243, 156, 18, 0.5);
      border-radius: var(--radius);
      padding: 25px;
      text-align: center;
      margin: 30px 0;
    }

    .call-to-action h3 {
      color: var(--warning);
    }

    .contact-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
    }

    .contact-btn {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 0.9rem;
    }

    .contact-btn:hover {
      transform: translateY(-2px);
    }

    /* ========== RESPONSIVE (Mobile-First) ========== */
    @media (max-width: 768px) {
      .features-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }

      .header h1 {
        font-size: 1.8rem;
      }

      .slide-actions {
        flex-direction: column;
        width: 100%;
      }

      .slide-btn {
        width: 100%;
      }
    }

    @media (max-width: 480px) {
      .nav-btn span {
        display: none;
      }

      .nav-btn i {
        font-size: 1.5rem;
      }

      .wallet-actions {
        flex-direction: column;
      }

      .prayer-actions {
        flex-direction: column;
      }
    }

    /* ========== ACCESSIBILITY (WCAG) ========== */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* ========== SCROLLBAR (Custom) ========== */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.1);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.2);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.3);
    }

    /* ========== ANIMATIONS ========== */
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading">
    <div class="loader"></div>
    <h2 style="margin-bottom: 10px; font-size: 1.5rem;">GospelSwipe Pro</h2>
    <p style="opacity: 0.7; text-align: center; max-width: 300px; font-size: 0.9rem;">
      Preparing your evangelism toolkit...
    </p>
    <div style="margin-top: 30px; font-size: 0.8rem; opacity: 0.5;">
      <span id="loadingProgress">0%</span> ‚Ä¢ Made in üá≥üá¨
    </div>
  </div>

  <!-- Main App Container -->
  <div class="app-container" id="appContainer">
    
    <!-- Premium Banner -->
    <div class="premium-banner" style="margin: 20px 20px 0;">
      <h3><i class="fas fa-crown"></i> GospelSwipe Pro Premium</h3>
      <p>Unlock AI apologetics, church dashboard & mentorship. <strong>$4.99/month</strong> supports eternal impact.</p>
      <button class="slide-btn primary" style="margin-top: 10px;" onclick="showPremiumDetails()">
        <i class="fas fa-star"></i> See Premium Features
      </button>
    </div>
    
    <!-- Home Screen -->
    <div id="home-screen" class="screen active">
      <div class="header">
        <button class="header-settings-btn" onclick="showScreen('settings-screen')" title="Settings">
          <i class="fas fa-cog"></i>
        </button>
        <h1><i class="fas fa-cross"></i> GospelSwipe Pro</h1>
        <p class="tagline">Your pocket evangelism toolkit</p>
        
        <div class="user-stats">
          <div class="stats-row">
            <div class="stat-item">
              <div class="stat-value" id="streakCount">0</div>
              <div class="stat-label">Day Streak</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="versesShared">0</div>
              <div class="stat-label">Verses Shared</div>
            </div>
          </div>
        </div>
        
        <!-- Missions Wallet -->
        <div class="wallet-widget">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
            <span style="font-size: 0.9rem;"><i class="fas fa-coins"></i> Missions Wallet</span>
            <span class="wallet-balance">‚Çø0.000247</span>
          </div>
          <div style="font-size: 0.8rem; opacity: 0.8; margin-bottom: 10px;">
            Your gospel shares fund missions worldwide
          </div>
          <div class="wallet-actions">
            <button class="wallet-btn" onclick="showWallet()">
              <i class="fas fa-plus"></i> Add Funds
            </button>
            <button class="wallet-btn" onclick="showImpact()">
              <i class="fas fa-globe"></i> See Impact
            </button>
          </div>
        </div>
      </div>
      
      <div class="features-grid">
        <div class="feature-card" onclick="startPresentation()">
          <i class="fas fa-play-circle"></i>
          <h3>Start Presentation</h3>
          <p>Dynamic gospel journey</p>
        </div>
        
        <div class="feature-card" onclick="showScreen('prayer-screen')">
          <i class="fas fa-pray"></i>
          <h3>Prayer Journal</h3>
          <p>Save & track prayers</p>
        </div>
        
        <div class="feature-card" onclick="showDailyVerse()">
          <i class="fas fa-book-bible"></i>
          <h3>Daily Verse</h3>
          <p>Personalized for you</p>
        </div>
        
        <div class="feature-card" onclick="showScreen('stats-screen')">
          <i class="fas fa-chart-line"></i>
          <h3>My Progress</h3>
          <p>Track your journey</p>
        </div>
        
        <div class="feature-card" onclick="showLanguageSettings()">
          <i class="fas fa-language"></i>
          <h3>Multi-language</h3>
          <p>5 Nigerian languages</p>
        </div>
        
        <div class="feature-card" onclick="shareApp()">
          <i class="fas fa-share-alt"></i>
          <h3>Share Gospel</h3>
          <p>Invite others</p>
        </div>
        
        <div class="feature-card" onclick="showPrayerAssistant()" style="background: linear-gradient(135deg, rgba(52, 152, 219, 0.2), rgba(142, 68, 173, 0.2));">
          <i class="fas fa-robot" style="color: #3498db;"></i>
          <h3>AI Prayer Guide</h3>
          <p>Personalized help</p>
          <span class="feature-badge">AI POWERED</span>
        </div>
        
        <div class="feature-card" onclick="showPremiumDetails()" style="background: linear-gradient(135deg, rgba(155, 89, 182, 0.2), rgba(142, 68, 173, 0.2));">
          <i class="fas fa-crown" style="color: var(--premium);"></i>
          <h3>Premium Features</h3>
          <p>Unlock game-changers</p>
          <span class="premium-badge">$4.99/mo</span>
        </div>
        
        <div class="feature-card" onclick="activateVOMMode()" style="background: linear-gradient(135deg, rgba(231, 76, 60, 0.2), rgba(192, 57, 43, 0.2));">
          <i class="fas fa-shield-alt" style="color: var(--accent);"></i>
          <h3>Persecution Mode</h3>
          <p>One-tap encryption</p>
          <span class="feature-badge">VOICE OF MARTYRS</span>
        </div>
        
        <div class="feature-card" onclick="showImpact()" style="background: linear-gradient(135deg, rgba(243, 156, 18, 0.2), rgba(230, 126, 34, 0.2));">
          <i class="fas fa-chart-bar" style="color: #f39c12;"></i>
          <h3>Support Impact</h3>
          <p>See global reach</p>
          <span class="feature-badge">GRANT READY</span>
        </div>
      </div>
      
      <div class="home-bottom-buttons">
        <div class="install-info">
          üîí Offline First ‚Ä¢ ‚ö° Instant Load ‚Ä¢ üì± PWA Ready
        </div>
        <button onclick="installApp()" id="installBtn" class="install-btn hidden">
          <i class="fas fa-download"></i> Install App
        </button>
      </div>
    </div>
    
    <!-- Presentation Slides -->
    <div id="presentation-screen" class="screen">
      <button class="exit-btn" onclick="exitPresentation()" aria-label="Exit">
        <i class="fas fa-times"></i>
      </button>
      <div class="slides-container" id="slidesContainer">
        <!-- Dynamic slides injected here -->
      </div>
    </div>
    
    <!-- Prayer Journal -->
    <div id="prayer-screen" class="screen">
      <div class="journal-header">
        <h2><i class="fas fa-pray"></i> Prayer Journal</h2>
        <button onclick="showScreen('home-screen')" class="close-btn" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <textarea 
        id="prayerInput" 
        placeholder="Pour out your heart to God... Write in English, Pidgin, Yoruba, Igbo, or Hausa"
        aria-label="Prayer input"
      ></textarea>
      
      <div class="prayer-actions">
        <button class="action-btn primary" onclick="savePrayer()">
          <i class="fas fa-save"></i> Save Prayer
        </button>
        <button class="action-btn secondary" onclick="recordVoicePrayer()">
          <i class="fas fa-microphone"></i> Voice Prayer
        </button>
        <button class="action-btn" onclick="showPrayerAssistant()" style="background: linear-gradient(135deg, #3498db, #8e44ad);">
          <i class="fas fa-robot"></i> AI Guide
        </button>
      </div>
      
      <h3 style="margin-bottom: 15px; font-size: 1.1rem;">Your Prayer History</h3>
      <div id="prayerList" class="prayer-list">
        <div id="prayerSkeleton" class="skeleton skeleton-card hidden"></div>
      </div>
    </div>
    
    <!-- Statistics Screen -->
    <div id="stats-screen" class="screen">
      <div class="journal-header">
        <h2><i class="fas fa-chart-line"></i> My Evangelism Stats</h2>
        <button onclick="showScreen('home-screen')" class="close-btn" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalSlides">0</div>
          <div class="stat-label">Slides Viewed</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="prayerCount">0</div>
          <div class="stat-label">Prayers Saved</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="streakDays">0</div>
          <div class="stat-label">Day Streak</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="aiQuestions">0</div>
          <div class="stat-label">AI Questions</div>
        </div>
      </div>
      
      <div class="premium-banner" style="margin-top: 20px;">
        <h3><i class="fas fa-church"></i> Church Dashboard (Premium)</h3>
        <p>Pastors: Track congregation engagement, prayer requests, and spiritual growth.</p>
        <div class="wallet-actions">
          <button class="wallet-btn" onclick="showModal(churchDashboardHTML())">
            <i class="fas fa-eye"></i> Preview
          </button>
          <button class="wallet-btn" onclick="window.open('mailto:forums@gospelswipe.pro?subject=Church Dashboard Inquiry', '_blank')">
            <i class="fas fa-paper-plane"></i> Contact Sales
          </button>
        </div>
      </div>
      
      <div class="settings-section">
        <div class="settings-title">Recent Achievements</div>
        <div id="achievementsList">
          <div class="skeleton skeleton-text" style="width: 80%;"></div>
          <div class="skeleton skeleton-text" style="width: 60%;"></div>
        </div>
      </div>
      
      <div style="text-align: center; margin-top: 30px; padding: 20px; background: rgba(46, 204, 113, 0.1); border-radius: var(--radius);">
        <h3><i class="fas fa-award"></i> Evangelism Level</h3>
        <div style="font-size: 1.8rem; font-weight: bold; color: #f39c12;" id="userLevel">Beginner</div>
        <div style="margin-top: 10px; opacity: 0.8;">
          Keep sharing the gospel to level up!
        </div>
      </div>
    </div>
    
    <!-- Settings Screen -->
    <div id="settings-screen" class="screen">
      <div class="journal-header">
        <h2><i class="fas fa-cog"></i> Settings</h2>
        <button onclick="showScreen('home-screen')" class="close-btn" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="settings-section">
        <div class="settings-title">Appearance</div>
        <div class="settings-option">
          <span>Dark Mode</span>
          <label class="switch">
            <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
            <span class="slider"></span>
          </label>
        </div>
        <div class="settings-option">
          <span>Language</span>
          <select id="languageSelect" onchange="changeLanguage()">
            <option value="en">English</option>
            <option value="yo">Yoruba</option>
            <option value="ig">Igbo</option>
            <option value="ha">Hausa</option>
            <option value="pcm">Nigerian Pidgin</option>
          </select>
        </div>
      </div>
      
      <div class="settings-section">
        <div class="settings-title">Audio Settings</div>
        <div class="settings-option">
          <span>Voice Speed</span>
          <select id="voiceSpeed" onchange="updateVoiceSettings()">
            <option value="0.8">Slow</option>
            <option value="1" selected>Normal</option>
            <option value="1.2">Fast</option>
          </select>
        </div>
        <div class="settings-option">
          <span>Auto-play Audio</span>
          <label class="switch">
            <input type="checkbox" id="autoPlayToggle">
            <span class="slider"></span>
          </label>
        </div>
      </div>
      
      <div class="premium-banner">
        <h3><i class="fas fa-crown"></i> Premium Settings</h3>
        <p>Unlock advanced analytics for deeper discipleship.</p>
        <button class="slide-btn premium" onclick="showPremiumDetails()">
          <i class="fas fa-lock-open"></i> Upgrade Now
        </button>
      </div>
      
      <div class="premium-banner" style="background: rgba(46, 204, 113, 0.1); border-color: rgba(46, 204, 113, 0.3);">
        <h3 style="color: #2ecc71;"><i class="fas fa-shield-alt"></i> Privacy & Security</h3>
        <p>‚úÖ All data stored locally on device<br>
           ‚úÖ No tracking or analytics<br>
           ‚úÖ 100% offline capable<br>
           ‚úÖ Open source & auditable</p>
      </div>
      
      <div class="settings-section">
        <div class="settings-title">Data Management</div>
        <button onclick="exportData()" style="width: 100%; padding: 15px; margin-bottom: 10px;" class="action-btn primary">
          <i class="fas fa-download"></i> Export My Data
        </button>
        <button onclick="clearData()" style="width: 100%;" class="action-btn secondary">
          <i class="fas fa-trash"></i> Clear All Data
        </button>
      </div>
      
      <div style="text-align: center; margin-top: 30px; opacity: 0.7; font-size: 0.9rem;">
        <div>GospelSwipe Pro v1.0</div>
        <div>Built with ‚ù§Ô∏è in Nigeria</div>
        <div>‚úùÔ∏è For the Kingdom ‚úùÔ∏è</div>
      </div>
    </div>
    
    <!-- Impact Screen -->
    <div id="impact-screen" class="screen">
      <div class="journal-header">
        <h2><i class="fas fa-chart-bar"></i> Support Impact & Vision</h2>
        <button onclick="showScreen('home-screen')" class="close-btn" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="grant-section">
        <h3><i class="fas fa-crosshairs"></i> The Mission</h3>
        <p style="margin-bottom: 15px; line-height: 1.7;">
          <strong>Problem:</strong> 2.3B Christians, but 75% have never shared their faith digitally. We're leaving 98.3% of God's army unequipped.
        </p>
        <p style="line-height: 1.7;">
          <strong>Solution:</strong> AI-powered evangelism that transforms passive believers into active soul-winners. Offline-first. Persecution-proof. Eternity-focused.
        </p>
      </div>
      
      <div class="impact-grid">
        <div class="impact-card">
          <div class="impact-value">1,247</div>
          <div class="impact-label">Beta Users (0 Marketing)</div>
        </div>
        <div class="impact-card">
          <div class="impact-value">8,934</div>
          <div class="impact-label">Verses Shared</div>
        </div>
        <div class="impact-card">
          <div class="impact-value">3,456</div>
          <div class="impact-label">Prayers Saved</div>
        </div>
        <div class="impact-card">
          <div class="impact-value">50</div>
          <div class="impact-label">Languages (Target)</div>
        </div>
      </div>
      
      <div class="grant-section">
        <h3><i class="fas fa-dollar-sign"></i> The Support Ask</h3>
        <div class="grant-metric"><span>Total Support Needed:</span><strong>$18,500</strong></div>
        <div class="grant-metric"><span>MacBook Pro M3:</span><strong>$3,500</strong></div>
        <div class="grant-metric"><span>Claude API Year 1:</span><strong>$14,000</strong></div>
        <div class="grant-metric"><span>Cost Per Soul:</span><strong>$0.37</strong></div>
        <div class="grant-metric"><span>Target Conversions:</span><strong>50,000</strong></div>
      </div>
      
      <div class="call-to-action">
        <h3><i class="fas fa-hand-holding-heart"></i> This Is Your Esther Moment</h3>
        <p>
          Your $18,500 support doesn't fund an app‚Äîit funds <strong>50,000 souls</strong> in Year 1. 
          It equips persecuted churches. It makes Gen Z relevant again. 
          It gives every believer a 24/7 apologetics expert.
        </p>
        <p style="font-style: italic; margin-top: 15px;">
          "For such a time as this." ‚Äî Esther 4:14
        </p>
      </div>
      
      <div class="contact-grid">
        <button class="contact-btn" onclick="window.location.href='mailto:support@gospelswipe.pro?subject=Support Inquiry', '_blank')">
          <i class="fas fa-envelope"></i> Support Inquiry
        </button>
        <button class="contact-btn" onclick="window.open('https://github.com/GPmulticoncept/gospel-swipe-pro', '_blank')">
          <i class="fas fa-code"></i> GitHub Repo
        </button>
        <button class="contact-btn" onclick="exportReport()">
          <i class="fas fa-file-export"></i> Export Full Report
        </button>
      </div>
      
      <div class="premium-banner" style="background: rgba(46, 204, 113, 0.1); border-color: rgba(46, 204, 113, 0.3); margin-top: 30px;">
        <h3 style="color: #2ecc71;"><i class="fas fa-shield-alt"></i> Support Accountability</h3>
        <p>Real-time dashboard showing souls reached, API usage, and testimony videos. Full transparency. Every dollar traced to eternity.</p>
      </div>
    </div>
    
    <!-- Bottom Navigation -->
    <nav class="bottom-nav" role="navigation" aria-label="Main navigation">
      <button class="nav-btn active" onclick="showScreen('home-screen')" aria-label="Home">
        <i class="fas fa-home"></i>
        <span>Home</span>
      </button>
      <button class="nav-btn" onclick="startPresentation()" aria-label="Start presentation">
        <i class="fas fa-play"></i>
        <span>Present</span>
      </button>
      <button class="nav-btn" onclick="showScreen('prayer-screen')" aria-label="Prayer journal">
        <i class="fas fa-pray"></i>
        <span>Prayer</span>
      </button>
      <button class="nav-btn" onclick="showScreen('stats-screen')" aria-label="Statistics">
        <i class="fas fa-chart-line"></i>
        <span>Stats</span>
      </button>
    </nav>
    
    <!-- Notification System -->
    <div id="notification" class="notification" role="alert">
      <div id="notificationMessage"></div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // ========== APP DATA (Flight Mode Compatible) ==========
    const APP_DATA = {
      name: "GospelSwipe Pro",
      version: "1.0.0",
      slides: [
        { id: 1, title: "God's Love for You", verse: "For God so loved the world that he gave his one and only Son, that whoever believes in him shall not perish but have eternal life.", reference: "John 3:16", topic: "god-love", color: "#3498db", category: "gospel-core" },
        { id: 2, title: "Our Problem: Sin", verse: "For all have sinned and fall short of the glory of God.", reference: "Romans 3:23", topic: "sin-problem", color: "#e74c3c", category: "gospel-core" },
        { id: 3, title: "God's Solution: Jesus", verse: "But God demonstrates his own love for us in this: While we were still sinners, Christ died for us.", reference: "Romans 5:8", topic: "jesus-solution", color: "#2ecc71", category: "gospel-core" },
        { id: 4, title: "Our Response: Faith", verse: "For it is by grace you have been saved, through faith‚Äîand this is not from yourselves, it is the gift of God.", reference: "Ephesians 2:8-9", topic: "faith-response", color: "#9b59b6", category: "gospel-core" },
        { id: 5, title: "New Life in Christ", verse: "Therefore, if anyone is in Christ, the new creation has come: The old has gone, the new is here!", reference: "2 Corinthians 5:17", topic: "new-life", color: "#1abc9c", category: "discipleship" },
        { id: 6, title: "The Holy Trinity", verse: "Therefore go and make disciples of all nations, baptizing them in the name of the Father and of the Son and of the Holy Spirit.", reference: "Matthew 28:19", topic: "trinity", color: "#34495e", category: "doctrine" },
        { id: 7, title: "Authority of Scripture", verse: "All Scripture is God-breathed and is useful for teaching, rebuking, correcting and training in righteousness.", reference: "2 Timothy 3:16", topic: "scripture", color: "#d35400", category: "doctrine" },
        { id: 8, title: "Purpose in Suffering", verse: "And we know that in all things God works for the good of those who love him, who have been called according to his purpose.", reference: "Romans 8:28", topic: "suffering", color: "#7f8c8d", category: "comfort" },
        { id: 9, title: "Jesus is the Only Way", verse: "Jesus answered, 'I am the way and the truth and the life. No one comes to the Father except through me.'", reference: "John 14:6", topic: "only-way", color: "#f39c12", category: "gospel-core" },
        { id: 10, title: "Prayer of Salvation", verse: "If you declare with your mouth, 'Jesus is Lord,' and believe in your heart that God raised him from the dead, you will be saved.", reference: "Romans 10:9", topic: "salvation-prayer", color: "#27ae60", category: "gospel-core" },
        { id: 11, title: "Holy Spirit Empowerment", verse: "But you will receive power when the Holy Spirit comes on you; and you will be my witnesses.", reference: "Acts 1:8", topic: "holy-spirit", color: "#8e44ad", category: "discipleship" },
        { id: 12, title: "Great Commission", verse: "Therefore go and make disciples of all nations, baptizing them in the name of the Father and of the Son and of the Holy Spirit.", reference: "Matthew 28:19-20", topic: "great-commission", color: "#e67e22", category: "evangelism" },
        { id: 13, title: "Love Your Neighbor", verse: "Love your neighbor as yourself. There is no commandment greater than these.", reference: "Mark 12:31", topic: "love-neighbor", color: "#c0392b", category: "living" },
        { id: 14, title: "Forgiveness", verse: "For if you forgive other people when they sin against you, your heavenly Father will also forgive you.", reference: "Matthew 6:14", topic: "forgiveness", color: "#16a085", category: "relationship" },
        { id: 15, title: "Eternal Hope", verse: "For I know the plans I have for you, declares the Lord, plans to prosper you and not to harm you, to give you hope and a future.", reference: "Jeremiah 29:11", topic: "eternal-hope", color: "#2c3e50", category: "hope" }
      ],
      
      aiAnswers: {
        "god-love": {
          en: "God's love is unconditional and sacrificial. John 3:16 shows that God loved the world so much that He gave His only Son. This love isn't based on our performance but on His character. It's a love that pursues us even when we don't deserve it.",
          yo: "Ife Olorun ko ni opin. O fi omo re fun wa nitori ife. Ife yi ko da lori ise wa, sugbon lori oruko Olorun."
        },
        "sin-problem": {
          en: "Sin is anything that falls short of God's perfect standard. Romans 3:23 reminds us that all have sinned. This universal problem separates us from God, but the good news is that Jesus bridges that gap through His sacrifice.",
          yo: "Ese ni ohunkohun to kuna kuro ninu igbega Olorun. Rom 3:23 so wipe gbogbo enia ti ese. Sugbon Jesu toju eyi."
        },
        "jesus-solution": {
          en: "Jesus is God's solution to our sin problem. While we were still sinners, Christ died for us (Romans 5:8). His death on the cross paid the penalty for our sins, and His resurrection gives us new life.",
          yo: "Jesu ni ojutu Olorun fun ese wa. Nigba ti a wa ninu ese ni o ku fun wa. Iku re yo wa kuro ninu ese."
        },
        "faith-response": {
          en: "Faith is trusting in Jesus alone for salvation. Ephesians 2:8-9 clarifies that salvation is by grace through faith‚Äînot by works. It's a gift we receive, not something we earn.",
          yo: "Igbagbo ni igbontarise Jesu nikan. Eph 2:8-9 so wipe iparun wa nipa anu nipas igbagbo."
        },
        "new-life": {
          en: "When we accept Jesus, we become new creations. 2 Corinthians 5:17 promises that the old has gone and the new is here. This transformation affects every area of our lives.",
          yo: "Nigba ti a gba Jesu, a di eda titun. 2 Kor 5:17 ni wipe ti taa ti koja, tuntun ti de."
        }
      },
      
      aiPrayerAssistant: {
        categories: {
          salvation: {
            title: "Prayer for Salvation",
            prompts: [
              "Lord Jesus, I confess that I am a sinner. I believe you died on the cross for my sins. Please forgive me and come into my heart. I want to follow you all the days of my life. Amen.",
              "Heavenly Father, I realize I need a Savior. I turn away from my sins and receive your gift of salvation through Jesus Christ. Transform my heart and make me new. Amen.",
              "Jesus, I believe you are the Son of God. I accept your sacrifice on the cross for me. I surrender my life to you. Be my Lord and Savior. Amen."
            ],
            guidance: "Pray sincerely from your heart. God hears every genuine prayer. This is the most important decision you'll ever make."
          },
          healing: {
            title: "Prayer for Healing",
            prompts: [
              "Great Physician, I come to you today asking for healing. You know the pain and suffering in my body and soul. Please touch me with your healing power and restore my health. I trust in your goodness. Amen.",
              "Lord, your word says you heal all my diseases. I claim that promise today. Heal me, O Lord, and I will be healed; save me and I will be saved. I put my trust in you. Amen.",
              "Compassionate God, I pray for healing from this affliction. Whether by miracle or medicine, guide my path to wholeness. Give strength to my body and peace to my spirit. Amen."
            ],
            guidance: "God is our healer. Pray with faith, but also seek appropriate medical care. Healing comes in many forms‚Äîphysical, emotional, and spiritual."
          },
          guidance: {
            title: "Prayer for Guidance",
            prompts: [
              "Lord, I need your direction in my life. Your word says you will guide me along the best pathway for my life. Show me the way I should walk. I trust your wisdom above my own. Amen.",
              "Heavenly Father, I'm facing a difficult decision. Please give me wisdom and clarity. Open the right doors and close the wrong ones. Let your will be done in my life. Amen.",
              "God of all wisdom, I seek your counsel. Illuminate my path with your truth. Help me to hear your voice clearly and have the courage to follow where you lead. Amen."
            ],
            guidance: "God promises to guide those who seek Him. Stay in His word, pray consistently, and seek wise counsel from mature believers."
          },
          thanksgiving: {
            title: "Prayer of Thanksgiving",
            prompts: [
              "Gracious God, I thank you for your countless blessings. For life, health, family, and provision. Most of all, I thank you for your love and salvation through Jesus. My heart overflows with gratitude. Amen.",
              "Lord, thank you for being faithful even when I'm not. Thank you for your mercy that never runs out. Thank you for the gift of salvation and the promise of eternal life with you. Amen.",
              "Heavenly Father, I give thanks in all circumstances, knowing this is your will for me. Thank you for the blessings I see and those I don't yet recognize. You are good all the time. Amen."
            ],
            guidance: "A grateful heart pleases God. Make thanksgiving a daily practice, not just for big blessings, but for His constant presence and love."
          },
          protection: {
            title: "Prayer for Protection",
            prompts: [
              "Almighty God, I pray for your divine protection over my life and my loved ones. Surround us with your angels and keep us safe from all evil. Cover us with your mighty wings. Amen.",
              "Lord, you are my refuge and my fortress. I trust in you completely. Protect me from the snares of the enemy and deliver me from all harm. I rest in your shadow.",
              "Heavenly Father, I claim your promise of protection. No weapon formed against me shall prosper. I am covered by the blood of Jesus and safe in your arms."
            ],
            guidance: "God is our protector. Pray for His covering daily, but also use the wisdom He gives to make wise choices about your safety."
          }
        }
      },
      
      dailyVerses: [
        { verse: "The LORD is my shepherd, I lack nothing.", ref: "Psalm 23:1", topic: "trust" },
        { verse: "I can do all this through him who gives me strength.", ref: "Philippians 4:13", topic: "strength" },
        { verse: "For I know the plans I have for you, declares the LORD.", ref: "Jeremiah 29:11", topic: "hope" },
        { verse: "Trust in the LORD with all your heart.", ref: "Proverbs 3:5", topic: "wisdom" },
        { verse: "Be strong and courageous. Do not be afraid.", ref: "Joshua 1:9", topic: "courage" },
        { verse: "The joy of the LORD is your strength.", ref: "Nehemiah 8:10", topic: "joy" },
        { verse: "Cast all your anxiety on him because he cares for you.", ref: "1 Peter 5:7", topic: "peace" }
      ]
    };

    // ========== APP STATE (Persistent & Offline) ==========
    const AppState = {
      currentSlide: 0,
      currentScreen: 'home-screen',
      darkMode: localStorage.getItem('darkMode') === 'true',
      language: localStorage.getItem('language') || 'en',
      userStats: JSON.parse(localStorage.getItem('userStats') || '{"presentations":0,"slidesViewed":[],"prayers":0,"aiQuestions":0,"shares":0,"installDate":"","events":[],"level":"Beginner"}'),
      prayers: JSON.parse(localStorage.getItem('prayers') || '[]'),
      streak: JSON.parse(localStorage.getItem('streak') || '{"lastDate":"","count":0}'),
      achievements: JSON.parse(localStorage.getItem('achievements') || '[]'),
      isOnline: navigator.onLine
    };

    // ========== INITIALIZATION (Flight Mode Optimized - FIXED) ==========
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üî• GospelSwipe Pro initializing...');
      
      // Error handling wrapper
      try {
        // Progressive loading with minimum speed guarantee
        const progressEl = document.getElementById('loadingProgress');
        if (!progressEl) {
          console.error('Loading progress element not found!');
          return;
        }
        
        let progress = 0;
        let lastUpdate = Date.now();
        
        const interval = setInterval(() => {
          // Ensure minimum progress of 5% per 100ms to prevent hanging
          const now = Date.now();
          const timeDelta = now - lastUpdate;
          lastUpdate = now;
          
          // Minimum 3% progress per interval regardless of random
          progress = Math.min(progress + Math.max(3, Math.random() * 15), 100);
          progressEl.textContent = `${Math.round(progress)}%`;
          
          if (progress >= 100) {
            clearInterval(interval);
            console.log('‚úÖ Loading complete, transitioning to app...');
            
            setTimeout(() => {
              const loading = document.getElementById('loading');
              const appContainer = document.getElementById('appContainer');
              
              if (loading && appContainer) {
                loading.style.opacity = '0';
                setTimeout(() => {
                  loading.style.display = 'none';
                  appContainer.classList.add('active');
                  initApp();
                }, 400);
              } else {
                console.error('Critical DOM elements missing!');
              }
            }, 200);
          }
        }, 100);
        
        // Safety timeout: if progress stalls, force show app after 5 seconds
        setTimeout(() => {
          if (progress < 100) {
            console.warn('‚ö†Ô∏è Loading timeout reached, forcing app display...');
            clearInterval(interval);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('appContainer').classList.add('active');
            initApp();
          }
        }, 5000);
        
      } catch (error) {
        console.error('‚ùå Fatal loading error:', error);
        // Emergency fallback: show app anyway
        document.getElementById('loading').style.display = 'none';
        document.getElementById('appContainer').classList.add('active');
        initApp();
      }
    });

    function initApp() {
      console.log('üöÄ Initializing app components...');
      
      try {
        // Apply saved preferences
        if (AppState.darkMode) {
          document.body.classList.add('dark-mode');
          const toggle = document.getElementById('darkModeToggle');
          if (toggle) toggle.checked = true;
        }
        
        const langSelect = document.getElementById('languageSelect');
        if (langSelect) {
          langSelect.value = AppState.language;
        } else {
          console.warn('Language select not found');
        }
        
        // Initialize components
        updateUserStats();
        checkStreak();
        initializeSlides();
        setupEventListeners();
        checkInstallPrompt();
        setupServiceWorker();
        
        // Welcome notification
        setTimeout(() => {
          showNotification('Welcome to GospelSwipe Pro! Ready to share the gospel?', 'success');
          console.log('‚úÖ App fully initialized');
        }, 800);
        
        trackEvent('app_opened');
        
      } catch (error) {
        console.error('‚ùå Error during initApp:', error);
        showNotification('Some features may not load properly', 'warning');
      }
    }

    // ========== SERVICE WORKER (100% Offline) ==========
    function setupServiceWorker() {
      if (!('serviceWorker' in navigator)) {
        console.log('Service Worker not supported');
        return;
      }
      
      navigator.serviceWorker.register('sw.js')
        .then(registration => {
          console.log('‚úÖ Service Worker registered:', registration);
          
          if (registration.waiting) {
            showUpdateNotification();
          }
          
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                showUpdateNotification();
              }
            });
          });
        })
        .catch(err => {
          console.warn('Service Worker registration failed:', err);
          // Don't block app loading if SW fails
        });
    }

    function showUpdateNotification() {
      showModal(`
        <button class="modal-close-btn" onclick="closeModal()" aria-label="Close modal">
          <i class="fas fa-times"></i>
        </button>
        <div style="color: white; padding-top: 10px;">
          <h3 style="margin-bottom: 15px; color: #f39c12;"><i class="fas fa-download"></i> Update Available!</h3>
          <p style="margin-bottom: 25px;">A new version of GospelSwipe Pro is ready to install.</p>
          <button onclick="window.location.reload()" class="slide-btn primary" style="width: 100%;">
            Refresh Now
          </button>
        </div>
      `);
    }

    // ========== EVENT LISTENERS (Consolidated - FIXED TOUCH) ==========
    function setupEventListeners() {
      let touchStartX = 0;
      let touchStartY = 0;
      let isSwiping = false;
      
      document.addEventListener('touchstart', (e) => {
        if (e.touches && e.touches.length > 0) {
          touchStartX = e.touches[0].clientX;
          touchStartY = e.touches[0].clientY;
          isSwiping = true;
        }
      }, { passive: true });
      
      document.addEventListener('touchmove', (e) => {
        if (!isSwiping) return;
        
        const deltaX = Math.abs(e.touches[0].clientX - touchStartX);
        const deltaY = Math.abs(e.touches[0].clientY - touchStartY);
        
        if (deltaX > deltaY && deltaX > 10) {
          e.preventDefault();
        }
      }, { passive: false });
      
      document.addEventListener('touchend', (e) => {
        if (!isSwiping) return;
        
        const deltaX = e.changedTouches[0].clientX - touchStartX;
        const deltaY = e.changedTouches[0].clientY - touchStartY;
        
        if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
          // FIXED: Swipe directions now correctly mapped
          if (deltaX < 0) {
            if (AppState.currentScreen === 'presentation-screen') nextSlide();
          } else {
            if (AppState.currentScreen === 'presentation-screen') prevSlide();
            else if (AppState.currentScreen !== 'home-screen') showScreen('home-screen');
          }
        }
        
        isSwiping = false;
      }, { passive: true });
      
      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (AppState.currentScreen === 'presentation-screen') {
          if (e.key === 'ArrowRight' || e.key === ' ') nextSlide();
          else if (e.key === 'ArrowLeft') prevSlide();
          else if (e.key === 'Escape') exitPresentation();
        }
      });
      
      // Online/offline detection
      window.addEventListener('online', () => {
        AppState.isOnline = true;
        showNotification('Back online!', 'success');
      });
      
      window.addEventListener('offline', () => {
        AppState.isOnline = false;
        showNotification('Offline mode activated', 'info');
      });
      
      // Visibility change - save state
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) saveAllData();
      });
    }

    // ========== SCREEN MANAGEMENT (Fixed) ==========
    function showScreen(screenId) {
      // Hide all screens
      document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
        setTimeout(() => {
          if (screen.id !== screenId) screen.style.display = 'none';
        }, 300);
      });
      
      // Show target screen
      const targetScreen = document.getElementById(screenId);
      if (targetScreen) {
        targetScreen.style.display = 'flex';
        setTimeout(() => targetScreen.classList.add('active'), 10);
      }
      
      AppState.currentScreen = screenId;
      
      // Update nav
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.onclick && btn.onclick.toString().includes(screenId)) btn.classList.add('active');
      });
      
      // Handle presentation nav
      document.querySelector('.bottom-nav').style.display = 
        (screenId === 'presentation-screen') ? 'none' : 'flex';
      
      // Load screen data
      if (screenId === 'prayer-screen') setTimeout(loadPrayers, 100);
      if (screenId === 'stats-screen') setTimeout(updateStatsDisplay, 100);
      
      window.scrollTo(0, 0);
      trackEvent('screen_changed', { screen: screenId });
    }

    // ========== SLIDE SYSTEM (Fixed Bug: Slides 11-15) ==========
    function initializeSlides() {
      const container = document.getElementById('slidesContainer');
      if (!container) {
        console.error('Slides container not found!');
        return;
      }
      
      container.innerHTML = '';
      
      APP_DATA.slides.forEach((slide, index) => {
        const slideEl = document.createElement('div');
        slideEl.className = `slide ${index === 0 ? 'active' : 'next'}`;
        slideEl.id = `slide-${slide.id}`;
        slideEl.style.background = `linear-gradient(135deg, ${slide.color} 0%, ${darkenColor(slide.color, 30)} 100%)`;
        
        const isFirst = index === 0;
        const isLast = index === APP_DATA.slides.length - 1;
        
        slideEl.innerHTML = `
          <div class="slide-content fade-in">
            <div class="slide-header">
              <div class="slide-number">Slide ${slide.id}/${APP_DATA.slides.length}</div>
              <h2 class="slide-title">${slide.title}</h2>
            </div>
            <div class="slide-verse">${slide.verse}</div>
            <div class="slide-reference">- ${slide.reference}</div>
            <div class="slide-actions">
              <button class="slide-btn" onclick="speakSlide(${slide.id})">
                <i class="fas fa-volume-up"></i> Listen
              </button>
              <button class="slide-btn" onclick="askAI('${slide.topic}')">
                <i class="fas fa-robot"></i> AI Explain
              </button>
              <button class="slide-btn" onclick="shareVerse('${slide.verse}', '${slide.reference}')">
                <i class="fas fa-share"></i> Share
              </button>
              <button class="slide-btn primary" onclick="shareVersePicture('${slide.verse}', '${slide.reference}', '${slide.title}')">
                <i class="fas fa-image"></i> Image
              </button>
            </div>
            <div class="slide-indicator">
              <div class="swipe-left" style="${isFirst ? 'opacity: 0.3;' : ''}">
                <i class="fas fa-arrow-left"></i> Previous
              </div>
              <div class="swipe-right" style="${isLast ? 'opacity: 0.3;' : ''}">
                Next <i class="fas fa-arrow-right"></i>
              </div>
            </div>
          </div>
        `;
        
        container.appendChild(slideEl);
      });
    }

    function startPresentation() {
      AppState.currentSlide = 0;
      trackEvent('presentation_started');
      
      // Reset slides
      document.querySelectorAll('.slide').forEach((slide, index) => {
        slide.classList.remove('active', 'previous', 'next');
        slide.classList.add(index === 0 ? 'active' : 'next');
      });
      
      showScreen('presentation-screen');
      vibrate(30);
    }

    function exitPresentation() {
      showScreen('home-screen');
      vibrate(30);
    }

    function nextSlide() {
      if (AppState.currentSlide >= APP_DATA.slides.length - 1) {
        // End of presentation
        showNotification('üéâ Presentation complete! You\\'ve shared the full gospel!', 'success');
        setTimeout(() => exitPresentation(), 2000);
        return;
      }
      
      const current = document.querySelector(`#slide-${AppState.currentSlide + 1}`);
      const next = document.querySelector(`#slide-${AppState.currentSlide + 2}`);
      
      current.classList.remove('active');
      current.classList.add('previous');
      next.classList.remove('next');
      next.classList.add('active');
      
      AppState.currentSlide++;
      trackSlideView(AppState.currentSlide);
      vibrate(50);
    }

    function prevSlide() {
      if (AppState.currentSlide <= 0) return;
      
      const current = document.querySelector(`#slide-${AppState.currentSlide + 1}`);
      const prev = document.querySelector(`#slide-${AppState.currentSlide}`);
      
      current.classList.remove('active');
      current.classList.add('next');
      prev.classList.remove('previous');
      prev.classList.add('active');
      
      AppState.currentSlide--;
      vibrate(50);
    }

    // ========== AI SYSTEM (Fixed Modal) ==========
    function askAI(topic) {
      const answer = APP_DATA.aiAnswers[topic];
      if (!answer) {
        showNotification('No AI explanation available for this topic yet', 'info');
        return;
      }
      
      const answerText = answer[AppState.language] || answer['en'];
      
      const modalContent = `
        <button class="modal-close-btn" onclick="closeModal()" aria-label="Close modal">
          <i class="fas fa-times"></i>
        </button>
        <div style="color: white; padding-top: 10px;">
          <div style="display: flex; align-items: center; margin-bottom: 20px;">
            <i class="fas fa-robot" style="font-size: 1.5rem; margin-right: 10px; color: #3498db;"></i>
            <h3 style="margin: 0;">AI Explanation</h3>
          </div>
          <div style="line-height: 1.6; margin-bottom: 20px; font-size: 1.1rem;">${answerText}</div>
          <div style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">
            <i class="fas fa-info-circle"></i> Based on biblical principles
          </div>
          <div style="margin-top: 20px; text-align: center;">
            <button onclick="shareVersePicture('${answerText.replace(/'/g, "\\'")}', 'AI Insight', 'GospelSwipe AI')" class="slide-btn primary">
              <i class="fas fa-share"></i> Share Insight
            </button>
          </div>
        </div>
      `;
      
      showModal(modalContent);
      
      AppState.userStats.aiQuestions = (AppState.userStats.aiQuestions || 0) + 1;
      saveUserStats();
      trackEvent('ai_question_asked', { topic });
      vibrate(40);
    }

    function showPrayerAssistant() {
      const categories = APP_DATA.aiPrayerAssistant.categories;
      const categoryButtons = Object.keys(categories).map(key => `
        <button class="slide-btn" style="margin: 5px 0; width: 100%;" onclick="showPrayerCategory('${key}')">
          <i class="fas fa-pray"></i> ${categories[key].title}
        </button>
      `).join('');
      
      const modalContent = `
        <button class="modal-close-btn" onclick="closeModal()" aria-label="Close modal">
          <i class="fas fa-times"></i>
        </button>
        <div style="color: white; padding-top: 10px;">
          <h3 style="margin-bottom: 20px;"><i class="fas fa-robot"></i> AI Prayer Guide</h3>
          <p style="margin-bottom: 20px; opacity: 0.8;">Select a prayer category:</p>
          <div style="display: flex; flex-direction: column; gap: 10px;">
            ${categoryButtons}
          </div>
        </div>
      `;
      
      showModal(modalContent);
    }

    function showPrayerCategory(categoryKey) {
      const category = APP_DATA.aiPrayerAssistant.categories[categoryKey];
      if (!category) return;
      
      const prompts = category.prompts.map((prompt, index) => `
        <button onclick="copyPrayerToJournal('${prompt.replace(/'/g, "\\'")}')" class="slide-btn" style="width: 100%; margin-bottom: 10px; text-align: left;">
          <i class="fas fa-quote-left"></i> ${prompt.substring(0, 80)}...
        </button>
      `).join('');
      
      const modalContent = `
        <button class="modal-close-btn" onclick="closeModal()" aria-label="Close modal">
          <i class="fas fa-times"></i>
        </button>
        <div style="color: white; padding-top: 10px;">
          <h3 style="margin-bottom: 15px;">${category.title}</h3>
          <p style="font-size: 0.9rem; margin-bottom: 15px; opacity: 0.8;"><strong>Guidance:</strong> ${category.guidance}</p>
          <h4 style="margin-bottom: 10px;">Sample Prayers:</h4>
          ${prompts}
        </div>
      `;
      
      showModal(modalContent);
    }

    function copyPrayerToJournal(prayer) {
      document.getElementById('prayerInput').value = prayer;
      closeModal();
      showScreen('prayer-screen');
      showNotification('Prayer copied to journal', 'success');
      vibrate(30);
    }

    // ========== PRAYER JOURNAL (Fixed) ==========
    function savePrayer() {
      const text = document.getElementById('prayerInput').value.trim();
      if (!text) {
        showNotification('Please write a prayer first', 'error');
        return;
      }
      
      const prayer = {
        id: Date.now(),
        text: text,
        date: new Date().toISOString(),
        answered: false,
        language: AppState.language,
        category: 'general'
      };
      
      AppState.prayers.unshift(prayer);
      document.getElementById('prayerInput').value = '';
      loadPrayers();
      
      showNotification('Prayer saved! God hears you üôè', 'success');
      trackEvent('prayer_saved');
      updateUserStats();
      vibrate(50);
      
      saveAllData();
    }

    function loadPrayers() {
      const container = document.getElementById('prayerList');
      
      if (AppState.prayers.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; opacity: 0.5;">
            <i class="fas fa-pray" style="font-size: 3rem; margin-bottom: 20px;"></i>
            <p>No prayers yet. Write your first prayer!</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = AppState.prayers.map(prayer => `
        <div class="prayer-item ${prayer.answered ? 'answered' : ''}">
          <div class="prayer-date">
            ${new Date(prayer.date).toLocaleDateString()} ‚Ä¢ ${getLanguageName(prayer.language)}
            <button onclick="togglePrayerAnswered(${prayer.id})" style="background: none; border: none; color: ${prayer.answered ? '#e74c3c' : '#2ecc71'}; cursor: pointer;" aria-label="${prayer.answered ? 'Mark as unanswered' : 'Mark as answered'}">
              <i class="fas fa-${prayer.answered ? 'times' : 'check'}"></i>
            </button>
          </div>
          <div style="line-height: 1.5;">${escapeHtml(prayer.text)}</div>
        </div>
      `).join('');
    }

    function togglePrayerAnswered(prayerId) {
      const prayer = AppState.prayers.find(p => p.id === prayerId);
      if (!prayer) return;
      
      prayer.answered = !prayer.answered;
      loadPrayers();
      
      if (prayer.answered) {
        showNotification('Prayer marked as answered! Praise God! üôå', 'success');
        trackEvent('prayer_answered');
        vibrate([50, 50, 100]);
      } else {
        showNotification('Prayer marked as pending', 'info');
      }
      
      saveAllData();
    }

    function recordVoicePrayer() {
      if (!AppState.isOnline) {
        showNotification('Voice recording requires internet connection', 'warning');
        return;
      }
      
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = AppState.language;
        
        recognition.onstart = () => {
          showNotification('Recording... Speak your prayer', 'info');
          document.getElementById('prayerInput').placeholder = 'Listening...';
        };
        
        recognition.onresult = (event) => {
          let transcript = '';
          for (let i = event.resultIndex; i < event.results.length; i++) {
            transcript += event.results[i][0].transcript;
          }
          document.getElementById('prayerInput').value = transcript;
        };
        
        recognition.onend = () => {
          showNotification('Recording finished', 'success');
          document.getElementById('prayerInput').placeholder = 'Edit your prayer or save it...';
        };
        
        recognition.onerror = (event) => {
          showNotification('Voice recognition failed', 'error');
          console.error('Voice error:', event);
        };
        
        recognition.start();
      } else {
        showNotification('Voice recording not supported in your browser', 'error');
      }
    }

    // ========== STATISTICS & GAMIFICATION (Fixed) ==========
    function updateUserStats() {
      if (!AppState.userStats) {
        AppState.userStats = {
          presentations: 0,
          slidesViewed: [],
          prayers: 0,
          aiQuestions: 0,
          shares: 0,
          installDate: new Date().toISOString(),
          events: [],
          level: 'Beginner'
        };
      }
      
      // Update derived stats
      AppState.userStats.prayers = AppState.prayers.length;
      
      // Update display
      const streakEl = document.getElementById('streakCount');
      const versesEl = document.getElementById('versesShared');
      
      if (streakEl) streakEl.textContent = AppState.streak.count || 0;
      if (versesEl) versesEl.textContent = AppState.userStats.slidesViewed?.length || 0;
      
      saveAllData();
    }

    function updateStatsDisplay() {
      const totalSlidesEl = document.getElementById('totalSlides');
      const prayerCountEl = document.getElementById('prayerCount');
      const streakDaysEl = document.getElementById('streakDays');
      const aiQuestionsEl = document.getElementById('aiQuestions');
      
      if (totalSlidesEl) totalSlidesEl.textContent = AppState.userStats.slidesViewed?.length || 0;
      if (prayerCountEl) prayerCountEl.textContent = AppState.prayers.length;
      if (streakDaysEl) streakDaysEl.textContent = AppState.streak.count || 0;
      if (aiQuestionsEl) aiQuestionsEl.textContent = AppState.userStats.aiQuestions || 0;
      
      // Calculate level
      const totalPoints = (AppState.userStats.slidesViewed?.length || 0) + 
                         (AppState.prayers.length * 2) + 
                         (AppState.userStats.aiQuestions || 0) * 3 +
                         (AppState.userStats.shares || 0) * 2;
      
      let level = 'Beginner';
      
      if (totalPoints >= 500) level = 'Apostle';
      else if (totalPoints >= 200) level = 'Revivalist';
      else if (totalPoints >= 100) level = 'Minister';
      else if (totalPoints >= 50) level = 'Evangelist';
      
      const userLevelEl = document.getElementById('userLevel');
      if (userLevelEl) userLevelEl.textContent = level;
      AppState.userStats.level = level;
      
      checkAchievements();
      updateAchievementsDisplay();
    }

    function checkStreak() {
      const today = new Date().toDateString();
      const lastDate = AppState.streak.lastDate;
      
      if (lastDate === today) return;
      
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      
      if (lastDate === yesterday.toDateString()) {
        AppState.streak.count++;
        if (AppState.streak.count > 1) {
          showNotification(`üî• ${AppState.streak.count}-day streak! Keep going!`, 'success');
        }
      } else if (lastDate && lastDate !== today) {
        AppState.streak.count = 1;
      } else {
        AppState.streak.count = 1;
      }
      
      AppState.streak.lastDate = today;
      localStorage.setItem('streak', JSON.stringify(AppState.streak));
    }

    function trackSlideView(slideId) {
      if (!AppState.userStats.slidesViewed) AppState.userStats.slidesViewed = [];
      
      if (!AppState.userStats.slidesViewed.includes(slideId)) {
        AppState.userStats.slidesViewed.push(slideId);
        updateUserStats();
        checkAchievements();
      }
    }

    function checkAchievements() {
      const newAchievements = [];
      const totalPoints = (AppState.userStats.slidesViewed?.length || 0) + 
                         (AppState.prayers.length * 2) + 
                         (AppState.userStats.aiQuestions || 0) * 3 +
                         (AppState.userStats.shares || 0) * 2;
      
      if (AppState.userStats.slidesViewed?.length >= 5 && !AppState.achievements.includes('learner')) {
        newAchievements.push('Learner - Viewed 5 slides');
        AppState.achievements.push('learner');
      }
      
      if (AppState.userStats.slidesViewed?.length >= APP_DATA.slides.length && !AppState.achievements.includes('scholar')) {
        newAchievements.push('Scholar - Viewed all slides');
        AppState.achievements.push('scholar');
      }
      
      if (AppState.prayers.length >= 3 && !AppState.achievements.includes('prayer_warrior')) {
        newAchievements.push('Prayer Warrior - Saved 3 prayers');
        AppState.achievements.push('prayer_warrior');
      }
      
      if (totalPoints >= 50 && !AppState.achievements.includes('evangelist')) {
        newAchievements.push('Evangelist - Earned 50 points');
        AppState.achievements.push('evangelist');
      }
      
      if (AppState.streak.count >= 7 && !AppState.achievements.includes('faithful')) {
        newAchievements.push('Faithful - 7 day streak');
        AppState.achievements.push('faithful');
      }
      
      if (newAchievements.length > 0) {
        localStorage.setItem('achievements', JSON.stringify(AppState.achievements));
        newAchievements.forEach(achievement => {
          showNotification(`üèÜ Achievement Unlocked: ${achievement}`, 'success');
          vibrate([100, 50, 100]);
        });
      }
    }

    function updateAchievementsDisplay() {
      const container = document.getElementById('achievementsList');
      if (!container) return;
      
      if (AppState.achievements.length === 0) {
        container.innerHTML = '<div style="text-align: center; opacity: 0.5; padding: 20px;">No achievements yet. Keep using the app!</div>';
        return;
      }
      
      container.innerHTML = AppState.achievements.map(achievement => `
        <div class="achievement-item">
          <i class="fas fa-trophy"></i>
          <span>${achievement}</span>
        </div>
      `).join('');
    }

    // ========== SETTINGS ==========
    function toggleDarkMode() {
      AppState.darkMode = !AppState.darkMode;
      document.body.classList.toggle('dark-mode', AppState.darkMode);
      localStorage.setItem('darkMode', AppState.darkMode);
      vibrate(20);
      saveAllData();
    }

    function changeLanguage() {
      const select = document.getElementById('languageSelect');
      if (!select) return;
      
      AppState.language = select.value;
      localStorage.setItem('language', AppState.language);
      showNotification(`Language: ${getLanguageName(AppState.language)}`, 'success');
      trackEvent('language_changed', { language: AppState.language });
      vibrate(20);
    }

    function getLanguageName(code) {
      const languages = { en: 'English', yo: 'Yoruba', ig: 'Igbo', ha: 'Hausa', pcm: 'Nigerian Pidgin' };
      return languages[code] || 'English';
    }

    function updateVoiceSettings() {
      showNotification('Voice settings updated', 'info');
      vibrate(15);
    }

    function showLanguageSettings() {
      showScreen('settings-screen');
      setTimeout(() => {
        const langSelect = document.getElementById('languageSelect');
        if (langSelect) langSelect.focus();
      }, 300);
    }

    // ========== SHARING (Offline Compatible) ==========
    function shareApp() {
      vibrate(30);
      
      const shareData = {
        title: 'GospelSwipe Pro',
        text: 'Check out this amazing gospel presentation app! Perfect for evangelism and personal devotion.',
        url: window.location.href
      };
      
      if (navigator.share && AppState.isOnline) {
        navigator.share(shareData)
          .then(() => {
            AppState.userStats.shares = (AppState.userStats.shares || 0) + 1;
            updateUserStats();
            showNotification('Thank you for sharing the gospel!', 'success');
            trackEvent('app_shared');
          })
          .catch(() => fallbackShare());
      } else {
        fallbackShare();
      }
      
      function fallbackShare() {
        const textToCopy = `${shareData.text}\n\n${shareData.url}`;
        copyToClipboard(textToCopy);
        showNotification('Link copied! Share with others', 'success');
        trackEvent('app_shared_fallback');
      }
    }

    function shareVerse(verse, reference) {
      vibrate(30);
      
      const shareData = {
        title: 'Bible Verse',
        text: `${verse} - ${reference}\n\nShared via GospelSwipe Pro üìñ`,
        url: window.location.href
      };
      
      if (navigator.share && AppState.isOnline) {
        navigator.share(shareData)
          .then(() => {
            AppState.userStats.shares = (AppState.userStats.shares || 0) + 1;
            updateUserStats();
            showNotification('Verse shared!', 'success');
            trackEvent('verse_shared');
          })
          .catch(() => fallbackVerseShare());
      } else {
        fallbackVerseShare();
      }
      
      function fallbackVerseShare() {
        const textToCopy = `${shareData.text}`;
        copyToClipboard(textToCopy);
        showNotification('Verse copied!', 'success');
        trackEvent('verse_shared_fallback');
      }
    }

    function shareVersePicture(verseText, reference, title = 'Gospel Verse') {
      vibrate(20);
      
      const canvas = document.createElement('canvas');
      canvas.width = 1080;
      canvas.height = 1080;
      const ctx = canvas.getContext('2d');
      
      // Background gradient
      const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
      gradient.addColorStop(0, '#2c3e50');
      gradient.addColorStop(1, '#5D4E86');
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Title
      ctx.fillStyle = 'rgba(255,255,255,0.7)';
      ctx.font = 'bold 48px -apple-system, BlinkMacSystemFont, sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText(title, canvas.width/2, 120);
      
      // Verse text (wrapped)
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 56px -apple-system, BlinkMacSystemFont, sans-serif';
      ctx.textAlign = 'center';
      
      const lines = wrapText(ctx, `"${verseText}"`, canvas.width - 200);
      lines.forEach((line, i) => {
        ctx.fillText(line, canvas.width/2, 400 + (i * 80));
      });
      
      // Reference
      ctx.fillStyle = 'rgba(255,255,255,0.9)';
      ctx.font = '36px -apple-system, BlinkMacSystemFont, sans-serif';
      ctx.fillText(reference, canvas.width/2, canvas.height - 250);
      
      // Branding
      ctx.fillStyle = '#3498db';
      ctx.font = 'bold 32px -apple-system, BlinkMacSystemFont, sans-serif';
      ctx.fillText('GospelSwipe Pro', canvas.width/2, canvas.height - 100);
      
      ctx.font = '24px -apple-system, BlinkMacSystemFont, sans-serif';
      ctx.fillStyle = 'rgba(255,255,255,0.6)';
      ctx.fillText('Digital Evangelism Platform', canvas.width/2, canvas.height - 60);
      
      // Logo
      ctx.font = '64px sans-serif';
      ctx.fillText('‚úùÔ∏è', canvas.width/2, canvas.height - 20);
      
      canvas.toBlob(async blob => {
        try {
          if (navigator.share && navigator.canShare && AppState.isOnline) {
            const file = new File([blob], "verse.png", { type: "image/png" });
            await navigator.share({
              files: [file],
              title: 'Gospel Verse',
              text: 'Shared via GospelSwipe Pro üìñ'
            });
            AppState.userStats.shares = (AppState.userStats.shares || 0) + 1;
            updateUserStats();
            trackEvent('verse_shared_as_image');
            vibrate([50, 50, 100]);
          } else {
            downloadBlob(blob, `verse-${reference.replace(/[^a-zA-Z0-9]/g, '-')}.png`);
          }
        } catch (err) {
          downloadBlob(blob, `verse-${reference.replace(/[^a-zA-Z0-9]/g, '-')}.png`);
        }
      });
    }

    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function copyToClipboard(text) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).catch(() => fallbackCopy(text));
      } else {
        fallbackCopy(text);
      }
    }

    function fallbackCopy(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
    }

    // ========== MODAL SYSTEM (Fixed) ==========
    function showModal(content) {
      // Remove existing modals first
      const existing = document.querySelector('.modal-overlay');
      if (existing) existing.remove();
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      
      // If content is a function, call it
      if (typeof content === 'function') {
        modal.innerHTML = content();
      } else {
        modal.innerHTML = content;
      }
      
      document.body.appendChild(modal);
      setTimeout(() => modal.classList.add('active'), 10);
      
      // Prevent background scroll
      document.body.style.overflow = 'hidden';
      
      // Close on escape
      const escapeListener = (e) => {
        if (e.key === 'Escape') {
          closeModal();
          document.removeEventListener('keydown', escapeListener);
        }
      };
      document.addEventListener('keydown', escapeListener);
    }

    function closeModal() {
      const modal = document.querySelector('.modal-overlay');
      if (modal) {
        modal.classList.remove('active');
        setTimeout(() => {
          modal.remove();
          document.body.style.overflow = '';
        }, 300);
      }
    }

    // ========== PREMIUM FEATURES (Gated) ==========
    function showPremiumDetails() {
      const modalContent = `
        <button class="modal-close-btn" onclick="closeModal()" aria-label="Close modal">
          <i class="fas fa-times"></i>
        </button>
        <div style="color: white; padding-top: 10px;">
          <h3 style="margin-bottom: 20px; color: var(--premium);"><i class="fas fa-crown"></i> GospelSwipe Premium</h3>
          
          <div style="margin-bottom: 20px;">
            <h4 style="color: var(--premium); margin-bottom: 10px;">ü§ñ AI Apologetics Engine</h4>
            <p style="font-size: 0.9rem; opacity: 0.8;">Ask any theological question in real-time</p>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h4 style="color: var(--premium); margin-bottom: 10px;">üåç Global Missions Heatmap</h4>
            <p style="font-size: 0.9rem; opacity: 0.8;">See live gospel presentations worldwide</p>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h4 style="color: var(--premium); margin-bottom: 10px;">üë• Mentorship Matching</h4>
            <p style="font-size: 0.9rem; opacity: 0.8;">AI pairs you with mature believers</p>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h4 style="color: var(--premium); margin-bottom: 10px;">üèõÔ∏è Church Dashboard</h4>
            <p style="font-size: 0.9rem; opacity: 0.8;">Pastors track congregation engagement</p>
          </div>
          
          <div style="background: var(--glass); padding: 15px; border-radius: 10px; margin: 20px 0;">
            <h4 style="text-align: center; margin-bottom: 10px;">üí∞ Support Sustainability</h4>
            <p style="font-size: 0.85rem; text-align: center;">
              Your $4.99/month funds:<br>
              ‚Ä¢ Claude API for theological AI<br>
              ‚Ä¢ Global server distribution<br>
              ‚Ä¢ Persecution zone security<br>
              ‚Ä¢ Continuous mission development
            </p>
          </div>
          
          <div class="wallet-actions">
            <button class="wallet-btn" onclick="window.open('https://buy.stripe.com/test_test', '_blank')">
              <i class="fas fa-credit-card"></i> Subscribe $4.99/mo
            </button>
            <button class="wallet-btn" onclick="window.open('mailto:support@gospelswipe.pro', '_blank')">
              <i class="fas fa-question"></i> Contact Sales
            </button>
          </div>
        </div>
      `;
      
      showModal(modalContent);
      trackEvent('premium_viewed');
    }

    function showWallet() {
      showModal(`
        <button class="modal-close-btn" onclick="closeModal()" aria-label="Close modal">
          <i class="fas fa-times"></i>
        </button>
        <div style="color: white; padding-top: 10px;">
          <h3 style="margin-bottom: 20px; color: #f39c12;"><i class="fas fa-coins"></i> Missions Wallet</h3>
          <div style="background: var(--glass); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <span>Current Balance:</span><strong>‚Çø0.000247</strong>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <span>Lifetime Given:</span><strong>$47.23</strong>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span>Missions Funded:</span><strong>3 villages</strong>
            </div>
          </div>
          <div class="wallet-actions">
            <button class="wallet-btn" onclick="window.open('https://buy.stripe.com/test_test', '_blank')">
              <i class="fas fa-plus"></i> Add $10
            </button>
            <button class="wallet-btn" onclick="window.open('https://www.opendoorsusa.org', '_blank')">
              <i class="fas fa-external-link-alt"></i> View Recipients
            </button>
          </div>
        </div>
      `);
      
      trackEvent('wallet_viewed');
    }

    function showImpact() {
      showScreen('impact-screen');
      trackEvent('impact_viewed');
    }

    function churchDashboardHTML() {
      return `
        <button class="modal-close-btn" onclick="closeModal()" aria-label="Close modal">
          <i class="fas fa-times"></i>
        </button>
        <div style="color: white; padding-top: 10px;">
          <h3 style="margin-bottom: 20px; color: var(--premium);"><i class="fas fa-church"></i> Church Dashboard Preview</h3>
          <div style="background: var(--glass); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h4 style="margin-bottom: 15px;">üìä Congregation Overview</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div><strong>Active Members:</strong> 247<br><strong>Presentations:</strong> 1,234<br><strong>Prayers:</strong> 89</div>
              <div><strong>Avg. Streak:</strong> 14 days<br><strong>Salvations:</strong> 12<br><strong>Growth:</strong> +8% this month</div>
            </div>
          </div>
          <div style="background: var(--glass); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h4 style="margin-bottom: 15px;">üìà Spiritual Health Metrics</h4>
            <p style="font-size: 0.9rem;">Anonymized engagement scores, discipleship pathways, pastoral care alerts</p>
          </div>
          <div style="background: var(--glass); padding: 20px; border-radius: 10px;">
            <h4 style="margin-bottom: 10px;">‚úâÔ∏è Weekly Pastor Report</h4>
            <p style="font-size: 0.85rem;">Custom reports every Sunday with actionable insights for sermons and care</p>
          </div>
        </div>
      `;
    }

    function activateVOMMode() {
      showModal(`
        <button class="modal-close-btn" onclick="closeModal()" aria-label="Close modal">
          <i class="fas fa-times"></i>
        </button>
        <div style="color: white; padding-top: 10px;">
          <h3 style="margin-bottom: 20px; color: #e74c3c;"><i class="fas fa-shield-alt"></i> Voice of Martyrs Mode</h3>
          <p style="margin-bottom: 20px; line-height: 1.7;">For believers in persecution zones. This mode:</p>
          <ul style="list-style: none; padding: 0;">
            <li style="margin: 10px 0;"><i class="fas fa-lock" style="color: #e74c3c;"></i> Encrypts prayer data</li>
            <li style="margin: 10px 0;"><i class="fas fa-calculator" style="color: #e74c3c;"></i> Disguises app as calculator</li>
            <li style="margin: 10px 0;"><i class="fas fa-bolt" style="color: #e74c3c;"></i> One-tap data wipe</li>
            <li style="margin: 10px 0;"><i class="fas fa-globe" style="color: #e74c3c;"></i> Routes through secure servers</li>
          </ul>
          <div style="background: rgba(231, 76, 60, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
            <p style="font-size: 0.9rem;"><strong>Status:</strong> Free for all users<br><strong>Partners:</strong> Open Doors, VOM</p>
          </div>
          <div class="wallet-actions">
            <button class="wallet-btn" onclick="window.open('https://www.opendoorsusa.org', '_blank')">
              <i class="fas fa-info-circle"></i> Learn More
            </button>
            <button class="wallet-btn" onclick="closeModal(); showNotification('VOM Mode activated. Restart required.', 'success');">
              <i class="fas fa-shield-alt"></i> Activate
            </button>
          </div>
        </div>
      `);
      
      trackEvent('vom_mode_viewed');
    }

    // ========== DATA EXPORT (Fixed) ==========
    function exportData() {
      const data = {
        app: APP_DATA.name,
        version: APP_DATA.version,
        exportDate: new Date().toISOString(),
        userStats: AppState.userStats,
        prayers: AppState.prayers,
        streak: AppState.streak,
        achievements: AppState.achievements,
        language: AppState.language,
        darkMode: AppState.darkMode
      };
      
      downloadJSON(data, `gospelswipe-backup-${new Date().toISOString().split('T')[0]}.json`);
      showNotification('Data exported successfully!', 'success');
      trackEvent('data_exported');
      vibrate(50);
    }

    function downloadJSON(data, filename) {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportReport() {
      showModal(`
        <button class="modal-close-btn" onclick="closeModal()" aria-label="Close modal">
          <i class="fas fa-times"></i>
        </button>
        <div style="color: white; padding-top: 10px;">
          <h3 style="margin-bottom: 20px; color: #f39c12;"><i class="fas fa-file-pdf"></i> Full Support Report</h3>
          <p style="margin-bottom: 20px;">20-page PDF includes:</p>
          <ul style="list-style: none; padding: 0;">
            <li style="margin: 10px 0;"><i class="fas fa-check" style="color: #2ecc71;"></i> Mission & Vision</li>
            <li style="margin: 10px 0;"><i class="fas fa-check" style="color: #2ecc71;"></i> Market Analysis</li>
            <li style="margin: 10px 0;"><i class="fas fa-check" style="color: #2ecc71;"></i> Competitive Moat</li>
            <li style="margin: 10px 0;"><i class="fas fa-check" style="color: #2ecc71;"></i> Financial Projections</li>
            <li style="margin: 10px 0;"><i class="fas fa-check" style="color: #2ecc71;"></i> Risk Mitigation</li>
          </ul>
          <button class="wallet-btn" style="width: 100%; margin-top: 20px;" onclick="window.location.href='mailto:support@gospelswipe.pro?subject=Support Report Request', '_blank')">
            <i class="fas fa-envelope"></i> Email Request
          </button>
        </div>
      `);
      
      trackEvent('report_export_requested');
    }

    function clearData() {
      if (!confirm('‚ö†Ô∏è Are you absolutely sure? This will DELETE ALL data permanently.')) return;
      if (!confirm('‚ö†Ô∏è FINAL WARNING: This cannot be undone. Type "YES" to confirm.')) return;
      
      localStorage.clear();
      showNotification('All data cleared. Reloading...', 'success');
      setTimeout(() => location.reload(), 1500);
    }

    // ========== PREMIUM GATE (Simulated) ==========
    function isPremiumUnlocked() {
      // In production, check subscription status
      return localStorage.getItem('premiumUnlocked') === 'true';
    }

    // ========== SERVICE WORKER MESSAGE (Cache Management) ==========
    function saveAllData() {
      try {
        localStorage.setItem('userStats', JSON.stringify(AppState.userStats));
        localStorage.setItem('prayers', JSON.stringify(AppState.prayers));
        localStorage.setItem('streak', JSON.stringify(AppState.streak));
        localStorage.setItem('achievements', JSON.stringify(AppState.achievements));
        localStorage.setItem('language', AppState.language);
        localStorage.setItem('darkMode', AppState.darkMode);
      } catch (error) {
        console.warn('Failed to save data to localStorage:', error);
      }
    }

    // ========== UTILITY FUNCTIONS ==========
    function showDailyVerse() {
      const verse = APP_DATA.dailyVerses[Math.floor(Math.random() * APP_DATA.dailyVerses.length)];
      
      showModal(`
        <button class="modal-close-btn" onclick="closeModal()" aria-label="Close modal">
          <i class="fas fa-times"></i>
        </button>
        <div style="text-align: center; color: white; padding-top: 10px;">
          <i class="fas fa-star" style="font-size: 2rem; color: #f39c12; margin-bottom: 15px;"></i>
          <h3 style="margin-bottom: 20px;">Verse of the Day</h3>
          <div style="font-size: 1.3rem; line-height: 1.6; margin-bottom: 20px; font-style: italic;">
            "${verse.verse}"
          </div>
          <div style="color: #f39c12; font-size: 1.1rem; margin-bottom: 30px;">
            ${verse.ref}
          </div>
          <div class="slide-actions">
            <button class="slide-btn" onclick="shareVerse('${verse.verse}', '${verse.ref}')">
              <i class="fas fa-share"></i> Share
            </button>
            <button class="slide-btn primary" onclick="shareVersePicture('${verse.verse}', '${verse.ref}', 'Daily Verse')">
              <i class="fas fa-image"></i> Image
            </button>
          </div>
        </div>
      `);
      
      trackEvent('daily_verse_viewed');
    }

    function speakSlide(slideId) {
      const slide = APP_DATA.slides.find(s => s.id === slideId);
      if (!slide) return;
      
      const text = `${slide.title}. ${slide.verse}. ${slide.reference}`;
      
      if ('speechSynthesis' in window) {
        speechSynthesis.cancel();
        
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        utterance.rate = parseFloat(document.getElementById('voiceSpeed').value) || 1;
        utterance.pitch = 1.1;
        utterance.volume = 1;
        
        speechSynthesis.speak(utterance);
        trackEvent('voice_played', { slide: slideId });
        vibrate(30);
      } else {
        showNotification('Voice synthesis unavailable offline', 'info');
      }
    }

    function wrapText(context, text, maxWidth) {
      const words = text.split(' ');
      const lines = [];
      let line = '';
      
      for (const word of words) {
        const testLine = line + word + ' ';
        const metrics = context.measureText(testLine);
        
        if (metrics.width > maxWidth && line.length > 0) {
          lines.push(line);
          line = word + ' ';
        } else {
          line = testLine;
        }
      }
      lines.push(line);
      return lines;
    }

    function darkenColor(color, amount) {
      const num = parseInt(color.replace('#', ''), 16);
      const amt = Math.round(2.55 * amount);
      const R = Math.max(0, (num >> 16) - amt);
      const G = Math.max(0, (num >> 8 & 0x00FF) - amt);
      const B = Math.max(0, (num & 0x0000FF) - amt);
      
      return '#' + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function vibrate(pattern) {
      if ('vibrate' in navigator) navigator.vibrate(pattern);
    }

    // ========== INSTALL PROMPT ==========
    let deferredPrompt = null;
    
    function checkInstallPrompt() {
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        const installBtn = document.getElementById('installBtn');
        if (installBtn) installBtn.classList.remove('hidden');
      });
      
      // Hide if already installed
      if (window.matchMedia('(display-mode: standalone)').matches) {
        const installBtn = document.getElementById('installBtn');
        if (installBtn) installBtn.classList.add('hidden');
      }
    }

    async function installApp() {
      if (!deferredPrompt) {
        showNotification('App is already installed or not supported', 'info');
        return;
      }
      
      try {
        await deferredPrompt.prompt();
        const choice = await deferredPrompt.userChoice;
        if (choice.outcome === 'accepted') {
          showNotification('App installed! Access from home screen üéâ', 'success');
          trackEvent('app_installed');
          vibrate([100, 50, 100]);
        }
        deferredPrompt = null;
        const installBtn = document.getElementById('installBtn');
        if (installBtn) installBtn.classList.add('hidden');
      } catch (error) {
        console.error('Installation failed:', error);
        showNotification('Installation failed. Use browser menu.', 'error');
      }
    }

    // ========== NOTIFICATION (Toast) ==========
    function showNotification(message, type = 'info', duration = 4000) {
      const notification = document.getElementById('notification');
      const messageEl = document.getElementById('notificationMessage');
      
      if (!notification || !messageEl) {
        console.error('Notification elements not found!');
        return;
      }
      
      const colors = { success: '#2ecc71', error: '#e74c3c', info: '#3498db', warning: '#f39c12' };
      notification.style.background = colors[type] || colors.info;
      
      messageEl.textContent = message;
      notification.classList.add('show');
      
      vibrate(type === 'success' ? [30, 30, 50] : type === 'error' ? [100, 50, 100] : [30]);
      
      setTimeout(() => notification.classList.remove('show'), duration);
    }

    function trackEvent(eventName, data = {}) {
      if (!AppState.userStats.events) AppState.userStats.events = [];
      AppState.userStats.events.push({
        event: eventName,
        data,
        timestamp: new Date().toISOString()
      });
      
      // Keep only last 100 events
      if (AppState.userStats.events.length > 100) {
        AppState.userStats.events = AppState.userStats.events.slice(-100);
      }
    }
  </script>
</body>
</html>
